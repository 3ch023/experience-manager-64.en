<?xml version="1.1" encoding="UTF-8" standalone="yes"?>
<html>
 <head>
  <meta content="audience:deploying" name="primaryAudienceTag" />
  <meta content="898b54f1-d2b8-4821-bc32-9bcabfb16e14" name="jcr:uuid" />
  <meta content="2018-04-03T08:46:52.446-0400" name="publishExternalDate" />
  <meta content="help/components/pages/article-3" name="sling:resourceType" />
  <meta content="/content/help/en/experience-manager/6-4/sites/deploying/morehelp/upgrading;/content/help/en/experience-manager/6-4/sites/deploying/morehelp/upgrading" name="moreHelpPaths" />
  <meta content="/apps/help/templates/article-3" name="cq:template" />
  <meta content="Activate" name="cq:lastReplicationAction" />
  <meta content="2018-04-03T08:46:52.446-0400" name="topicBrowsingSortDate" />
  <meta content="" name="jcr:primaryType" />
  <meta content="2018-04-03T08:46:53.130-0400" name="cq:lastReplicated" />
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/upgrade-procedure.html" name="publishExternalURL" />
  <meta content="2018-04-30T03:29:21.892-0400" name="cq:lastModified" />
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" />
  <meta content="2018-02-10T08:01:17.805-0500" name="jcr:created" />
  <meta content="Upgrade Procedure" name="seoTitle" />
  <meta content="en" name="pageCreatedAt" />
  <meta content="/etc/designs/help" name="cq:designPath" />
  <meta content="Learn about the procedure you need to follow in order to upgrade AEM." name="seoDescription" />
  <meta content="2018-04-30T03:29:21.891-0400" name="locHandOffDate" />
  <meta content="target-audience:upgrader" name="targetAudience" />
  <meta content="en_us" name="jcr:language" />
  <meta content="5edbe7c6-d03a-4b1c-9aff-3eb267c37732" name="jcr:predecessors" />
  <meta content="true" name="jcr:isCheckedOut" />
  <meta content="topic_tags:upgrading;products:SG_EXPERIENCEMANAGER/6.4/SITES;content_type:reference" name="cq:tags" />
  <meta content="false" name="isReadyForLocalization" />
  <meta content="mix:versionable" name="jcr:mixinTypes" />
  <meta content="Upgrade Procedure" name="jcr:title" />
  <meta content="carlino" name="cq:lastReplicatedBy" />
  <meta content="sarchiz" name="cq:lastModifiedBy" />
  <meta content="" name="jcr:baseVersion" />
  <meta content="admin" name="jcr:createdBy" />
  <meta content="2017-11-29T07:06:08.933-0500" name="firstPublishExternalDate" />
  <meta content="sarchiz" name="contentOwner" />
  <meta content="" name="jcr:versionHistory" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" />
  <meta content="2018-04-03T08:46:52.446-0400" name="lastPublishExternalDate" />
 </head>
 <body>
  <note>
   <p>The upgrade will require downtime for the Author tier as most AEM upgrades are performed in-place. By following these best practices, Publish tier downtime can be minimized or eliminated.</p> 
  </note>
  <p>When upgrading your AEM environments, you need to consider the differences in approach between upgrading author environments or publish environments in order to minimize downtime for both you authors and end users. This page outlines the high level procedure for upgrading an AEM topology currently running on a version of AEM 6.x. Since the process differs between author and publish tiers as well as Mongo and TarMK based deployments, each tier and microkernel has been listed in a separate section. When executing your deployment, we recommend first upgrading your author environment, determining success, and then proceeding to the publish environments.</p> 
  <h2 id="tarmk-author-tier">TarMK Author Tier</h2>
  <h3 id="Starting Topology">Starting Topology</h3>
  <p>The assumed topology for this section consists of an Author server running on TarMK with a Cold Standby. Replication occurs from the Author server to the TarMK publish farm. While not illustrated here, this approach can also be leveraged for deployments that use offloading. Make sure to upgrade or rebuild the offloading instance on the new version after disabling replication agents on the Author instance and before re-enabling them.</p> 
  <img imageRotate="0" src="assets/tarmk_starting_topology.jpg" />
  <h3 id="Upgrade Preparation">Upgrade Preparation</h3>
  <img imageRotate="0" src="assets/upgrade-preparation-author.png" />
  <ol>
   <li><p>Stop content authoring<br /> </p> </li>
   <li><p>Stop the standby instance<br /> </p> </li>
   <li><p>Disable replication agents on the author<br /> </p> </li>
   <li><p>Run the <a href="../../../sites/deploying/using/pre-upgrade-maintenance-tasks.md">pre-upgrade maintenance tasks</a>.</p> </li>
  </ol>
  <h3 id="Upgrade Execution">Upgrade Execution</h3>
  <img imageRotate="0" src="assets/execute_upgrade.jpg" />
  <ol>
   <li><p>Run the <a href="../../../sites/deploying/using/in-place-upgrade.md">in-place upgrade</a></p> </li>
   <li><p>Update the dispatcher module <em>if needed</em><br /> </p> </li>
   <li><p>QA validates the upgrade<br /> </p> </li>
   <li><p>Shutdown the author instance.<br /> </p> </li>
  </ol>
  <h3 id="If Successful">If Successful</h3>
  <img imageRotate="0" src="assets/if_successful.jpg" />
  <ol>
   <li><p>Copy the upgraded instance to create a new Cold Standby<br /> </p> </li>
   <li><p>Start the Author instance<br /> </p> </li>
   <li><p>Start the Standby instance.<br /> </p> </li>
  </ol>
  <h3 id="If Unsuccessful (Rollback)">If Unsuccessful (Rollback)</h3>
  <img imageRotate="0" src="assets/rollback.jpg" />
  <ol>
   <li><p>Start the Cold Standby instance as the new Primary<br /> </p> </li>
   <li><p>Rebuild the Author environment from the Cold Standby.<br /> </p> </li>
  </ol>
  <h2 id="mongomk-author-cluster">MongoMK Author Cluster</h2>
  <h3 id="Starting Topology">Starting Topology</h3>
  <p>The assumed topology for this section consists of a MongoMK Author cluster with at least two AEM Author instances, backed by at least two MongoMK databases. All Author instances share a datastore. These steps should apply to both S3 and File datastores. Replication occurs from the Author servers to the TarMK Publish farm.</p> 
  <img imageRotate="0" src="assets/mongo-topology.jpg" />
  <h3 id="Upgrade Preparation">Upgrade Preparation</h3>
  <img imageRotate="0" src="assets/mongo-upgrade_prep.jpg" />
  <ol>
   <li><p>Stop content authoring<br /> </p> </li>
   <li><p>Clone the data store for backup<br /> </p> </li>
   <li><p>Stop all but one AEM Author instance, your primary Author</p> </li>
   <li><p>Remove all but one MongoDB node from the replica set, your primary Mongo instance </p> </li>
   <li><p>Update the <span class="code">DocumentNodeStoreService.cfg</span> file on the primary Author to reflect your single member replica set </p> </li>
   <li><p>Restart the primary Author to ensure that it restarts properly<br /> </p> </li>
   <li><p>Disable replication agents on the primary Author<br /> </p> </li>
   <li><p>Run <a href="../../../sites/deploying/using/pre-upgrade-maintenance-tasks.md">pre-upgrade maintenance tasks</a> on the primary Author instance<br /> </p> </li>
   <li><p>If necessary, upgrade MongoDB on the primary Mongo instance to version 3.2 with WiredTiger<br /> </p> </li>
  </ol>
  <h3 id="Upgrade Execution">Upgrade Execution</h3>
  <img imageRotate="0" src="assets/mongo-execution.jpg" />
  <ol>
   <li><p>Run an <a href="../../../sites/deploying/using/in-place-upgrade.md">in-place upgrade</a> on the primary Author<br /> </p> </li>
   <li><p>Update the Dispatcher or Web Module <em>if needed</em><br /> </p> </li>
   <li><p>QA validates the upgrade<br /> </p> </li>
  </ol>
  <h3 id="If Successful">If Successful</h3>
  <img imageRotate="0" src="assets/mongo-secondaries.jpg" />
  <ol>
   <li><p>Create new 6.3 Author instances, connected to the upgraded Mongo instance<br /> </p> </li>
   <li><p>Rebuild the MongoDB nodes that were removed from the cluster<br /> </p> </li>
   <li><p>Update the <span class="code">DocumentNodeStoreService.cfg</span> files to reflect the full replica set<br /> </p> </li>
   <li><p>Restart the Author instances, one at a time<br /> </p> </li>
   <li><p>Remove the cloned data store.<br /> </p> </li>
  </ol>
  <h3 id="If Unsuccessful (Rollback) ">If Unsuccessful (Rollback) </h3>
  <img imageRotate="0" src="assets/mongo-rollback.jpg" />
  <ol>
   <li><p>Reconfigure the secondary Author instances to connect to the cloned data store<br /> </p> </li>
   <li><p>Shut down the upgraded Author primary instance<br /> </p> </li>
   <li><p>Shut down the upgraded Mongo primary instance.<br /> </p> </li>
   <li><p>Start up the secondary Mongo instances with one of them as the new primary<br /> </p> </li>
   <li><p>Configure the <span class="code">DocumentNodeStoreService.cfg</span> files on the secondary Author instances to point to the replica set of not yet upgraded Mongo instances<br /> </p> </li>
   <li><p>Start up the secondary Author instances<br /> </p> </li>
   <li><p>Clean up the upgraded author instances, Mongo node and data store.</p> </li>
  </ol>
  <h2 id="tarmk-publish-farm">TarMK Publish Farm</h2>
  <h3 id="TarMK Publish Farm">TarMK Publish Farm</h3>
  <p>The assumed topology for this section consists of two TarMK publish instances, fronted by Dispatchers that are in turn fronted by a load balancer. Replication occurs from the Author server to the TarMK Publish farm.</p> 
  <img imageRotate="0" src="assets/tarmk-pub-farmv5.png" />
  <h3 id="Upgrade Execution">Upgrade Execution</h3>
  <img imageRotate="0" src="assets/upgrade-publish2.png" />
  <ol>
   <li><p>Stop traffic to the Publish 2 instance at the load balancer<br /> </p> </li>
   <li><p>Run <a href="../../../sites/deploying/using/pre-upgrade-maintenance-tasks.md">pre-upgrade maintenance</a> on Publish 2<br /> </p> </li>
   <li><p>Run an <a href="../../../sites/deploying/using/in-place-upgrade.md">in-place upgrade</a> on Publish 2<br /> </p> </li>
   <li><p>Update the Dispatcher or Web Module <em>if needed</em><br /> </p> </li>
   <li><p>Flush the Dispatcher cache<br /> </p> </li>
   <li><p>QA validates Publish 2 through the Dispatcher, behind the firewall<br /> </p> </li>
   <li><p>Shutdown Publish 2<br /> </p> </li>
   <li><p>Copy the Publish 2 instance<br /> </p> </li>
   <li><p>Start Publish 2<br /> </p> </li>
  </ol>
  <h3 id="If Successful">If Successful</h3>
  <img imageRotate="0" src="assets/upgrade-publish1.png" />
  <ol>
   <li><p>Enable traffic to Publish 2<br /> </p> </li>
   <li><p>Stop traffic to Publish 1<br /> </p> </li>
   <li><p>Stop the Publish 1 instance<br /> </p> </li>
   <li><p>Replace the Publish 1 instance with a copy of Publish 2<br /> </p> </li>
   <li><p>Update the Dispatcher or Web Module <em>if needed</em><br /> </p> </li>
   <li><p>Flush the Dispatcher cache for Publish 1<br /> </p> </li>
   <li><p>Start Publish 1<br /> </p> </li>
   <li><p>QA validates Publish 1 through the Dispatcher, behind the firewall<br /> </p> </li>
  </ol>
  <h3 id="If Unsuccessful (Rollback)">If Unsuccessful (Rollback)</h3>
  <img imageRotate="0" src="assets/pub_rollback.jpg" />
  <ol>
   <li><p>Create a copy of Publish 1<br /> </p> </li>
   <li><p>Replace the Publish 2 instance with a copy of Publish 1<br /> </p> </li>
   <li><p>Flush the Dispatcher cache for Publish 2<br /> </p> </li>
   <li><p>Start Publish 2<br /> </p> </li>
   <li><p>QA validates Publish 2 through the Dispatcher, behind the firewall<br /> </p> </li>
   <li><p>Enable traffic to Publish 2<br /> </p> </li>
  </ol>
  <h2 id="final-upgrade-steps">Final Upgrade Steps</h2>
  <ol>
   <li><p>Enable traffic to Publish 1<br /> </p> </li>
   <li><p>QA performs final validation from a public URL<br /> </p> </li>
   <li><p>Enable replication agents from the Author environment<br /> </p> </li>
   <li><p>Resume content authoring<br /> </p> </li>
   <li><p>Perform <a href="../../../sites/deploying/using/post-upgrade-checks-and-troubleshooting.md">post-upgrade checks</a>.</p> </li>
  </ol>
  <img imageRotate="0" src="assets/final.jpg" />
 </body>
</html>