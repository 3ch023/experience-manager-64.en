<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="carlino" name="cq:lastModifiedBy" /> 
  <meta content="2018-04-26T10:12:41.080-0400" name="locHandOffDate" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;topic_tags:Security;content_type:reference" name="cq:tags" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/administering/morehelp/security;/content/help/en/experience-manager/6-4/sites/administering/morehelp/security" name="moreHelpPaths" /> 
  <meta content="2018-04-03T07:04:44.482-0400" name="lastPublishExternalDate" /> 
  <meta content="2018-04-03T07:04:45.088-0400" name="cq:lastReplicated" /> 
  <meta content="2017-12-01T19:05:39.200-0500" name="jcr:created" /> 
  <meta content="2018-04-26T10:12:41.080-0400" name="cq:lastModified" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="Mitigating serialization issues in AEM" name="seoTitle" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="ea54b877-b7d4-4257-a4c1-90f4034f1705" name="jcr:predecessors" /> 
  <meta content="2018-04-03T07:04:44.482-0400" name="topicBrowsingSortDate" /> 
  <meta content="carlino" name="cq:lastReplicatedBy" /> 
  <meta content="2017-10-31T16:24:48.833-0400" name="firstPublishExternalDate" /> 
  <meta content="2018-04-03T07:04:44.482-0400" name="publishExternalDate" /> 
  <meta content="false" name="isReadyForLocalization" /> 
  <meta content="a0e47df2-86e5-4646-bcf2-e763f0cc5a28" name="jcr:uuid" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
  <meta content="audience:administering" name="primaryAudienceTag" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="Learn how to mitigate serialization issues in AEM." name="seoDescription" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="qaDate" /> 
  <meta content="Activate" name="cq:lastReplicationAction" /> 
  <meta content="Mitigating serialization issues in AEM" name="navTitle" /> 
  <meta content="/content/docs/en/aem/6-3/administer/security/mitigating-serialization-issues" name="qaNotes" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" /> 
  <meta content="Mitigating serialization issues in AEM" name="jcr:title" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="Guillaume Carlino" name="contentOwner" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/administering/using/mitigating-serialization-issues.html" name="publishExternalURL" /> 
 </head> 
 <body> 
  <h2>Overview</h2> 
  <p><br /> The AEM team at Adobe has been working closely with the open source project <a href="https://github.com/kantega/notsoserial">NotSoSerial</a> to assist in mitigating the vulnerabilities described in <strong>CVE-2015-7501</strong>. NotSoSerial is licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache 2 license</a> and includes ASM code licensed under its own <a href="http://asm.ow2.org/license.html">BSD-like license</a>.</p> 
  <p>The agent jar included with this package is Adobe's modified distribution of NotSoSerial. For more information, see the <a href="../../../sites/administering/using/mitigating-serialization-issues.md#main-pars-title-95812971">Revision History</a> section below.<br /> <br /> NotSoSerial is a Java level solution to a Java level problem and is not AEM specific. It adds a preflight check to an attempt to deserialize an object. This check will test a class name against a firewall-style whitelist and/or blacklist. Due to the limited number of classes in the default blacklist, this is unlikely to have an impact on your systems or code.</p> 
  <p>By default, the agent will perform a blacklist check against current known vulnerable classes. This blacklist is intended to protect you from the current list of exploits that use this type of vulnerability.</p> 
  <p>The blacklist and whitelist can be configured by following the instructions in the <a href="../../../sites/administering/using/mitigating-serialization-issues.md#main-pars-title-421094637">Configuring the Agent</a> section of this article.</p> 
  <p>The agent is intended to help mitigate the latest known vulnerable classes. If your project is deserializing untrusted data, it may still be vulnerable to denial of service attacks, out of memory attacks, and unknown future deserialization exploits.<br /> <br /> Adobe officially supports Java 6, 7, and 8, however our understanding is that NotSoSerial supports Java 5 as well.<br /> </p> 
  <h2>Installing the Agent</h2> 
  <note> 
   <p>If you have previously installed the serialization hotfix for AEM 6.1, please remove the agent start commands from your java execution line.<br /> </p> 
  </note> 
  <ol> 
   <li><p>Install the <strong>com.adobe.cq.cq-serialization-tester</strong> bundle.<br /> </p> </li> 
   <li><p>Go to the Bundle Web Console at <span class="code">http://server:port/system/console/bundles</span></p> </li> 
   <li><p>Look for the serialization bundle and start it. This should dynamically autoload the NotSoSerial agent.</p> </li> 
  </ol>  
  <h2>Installing the Agent on Application Servers</h2> 
  <p>The NotSoSerial agent is not included in the stardard distribution of AEM for application servers. However, you can extract it from the AEM jar distribution and use it with your application server setup:</p> 
  <ol> 
   <li><p>First, download the AEM quickstart file and extract it:</p> 
    <codeblock gutter="true" class="syntax shell">
      java&amp;nbsp;-jar&amp;nbsp;aem-quickstart-6.2.0.jar&amp;nbsp;-unpack 
    </codeblock></li> 
   <li><p>Go to the location of the newly unzipped AEM quickstart, and copy the <span class="code">crx-quickstart/opt/notsoserial/</span> folder to the <span class="code">crx-quickstart</span> folder of the AEM application server installation.<br /> </p> </li> 
   <li><p>Change the ownership of <span class="code">/opt</span> to the user running the server:</p> 
    <codeblock gutter="true" class="syntax shell">
      chown&amp;nbsp;-R&amp;nbsp;opt&amp;nbsp;&lt;user&amp;nbsp;running&amp;nbsp;the&amp;nbsp;server&gt; 
    </codeblock></li> 
   <li><p>Configure and check that the agent has been properly activated as shown in the following sections of this article.</p> </li> 
  </ol> 
  <h2>Configuring the agent</h2> 
  <p>The default configuration is adequate for most installs. This includes a blacklist of known remote execution vulnerable classes and a whitelist of packages where deserialization of trusted data should be relatively safe.<br /> <br /> <br /> The firewall configuration is dynamic, and can be changed at any time by:<br /> </p> 
  <ol> 
   <li><p>Going to the Web Console at <span class="code">http://server:port/system/console/configMgr</span></p> </li> 
   <li><p>Searching for and clicking <strong>Deserialization Firewall Configuration.</strong></p> 
    <note> 
     <p>You can also reach the configuration page directly by accessing the URL at:</p> 
     <ul> 
      <li><span class="code">http://server:port/system/console/configMgr/com.adobe.cq.deserfw.impl.DeserializationFirewallImpl</span></li> 
     </ul> 
    </note></li> 
  </ol> 
  <p>This configuration contains the whitelist, blacklist, and deserialization logging.<br /> </p> 
  <p><strong><u>Whitelisting</u></strong></p> 
  <p>In the whitelisting section, these are classes or package prefixes that will be allowed for deserialization. It is important to be aware that if you are deserializing classes of your own, you will need to add either the classes or packages to this whitelist.</p> 
  <p><strong><u>Blacklisting</u></strong><br /> <br /> In the blacklisting section are classes that are never allowed for deserializaiton. The initial set of these classes is limited to classes that have been found vulnerable to remote execution attacks. The blacklist is applied before any whitelisted entries.</p> 
  <p><strong><u>Diagnostinc Logging</u></strong><br /> <br /> In the section for diagnostic logging, you can chose several options to log when deserialization is taking place. These are only logged on first use, and are not logged again on subsequent uses.<br /> <br /> The default of <strong>class-name-only</strong> will inform you of the classes that are being deserialized.</p> 
  <p>You can also set the <strong>full-stack</strong> option which will log a java stack of the first deserialization attempt to inform you where your deserialization is taking place. This can be useful for finding and removing deserialization from your usage.<br /> </p> 
  <h2>Verifying the Agent's Activation</h2> 
  <p>You can verify the deserialization agent's configuration by browsing to the URL at:</p> 
  <ul> 
   <li><span class="code">http://server:port/system/console/healthcheck?tags=deserialization</span></li> 
  </ul> 
  <p>Once you access the URL, a list of health checks related to the agent will be displayed. You can determine if the agent is properly activated by verifying that the health checks are passing. If they are failing, you may need to load the agent manually.</p> 
  <p>For more information on troubleshooting issues with the agent, see <a href="#main-pars-title-1104713798">Handling Errors With Dynamic Agent Loading</a> below.</p> 
  <note> 
   <p>If you add <span class="code">org.apache.commons.collections.functors</span> to the whitelist, the health check will always fail.<br /> </p> 
  </note> 
  <h2>Handling errors with dynamic agent loading</h2> 
  <p>If errors are exposed in the log, or the verification steps detect a problem loading the agent, you might need to load the agent manually. This is also recommended in case you are using a JRE (Java Runtime Environment) instead of a JDK (Java Development Toolkit), since the tools for dynamic loading are not available.</p> 
  <p>In order to load the agent manually, follow the below instructions:<br /> </p> 
  <ol> 
   <li><p>Modify the JVM startup parameters of the CQ jar, adding the following option:</p> 
    <codeblock class="syntax shell">
      -javaagent:&lt;aem-installation-folder&gt;/crx-quickstart/opt/notsoserial/notsoserial.jar 
    </codeblock> 
    <note> 
     <p>This requires using the -nofork CQ/AEM option as well, along with the appropriate JVM memory settings, as the agent won't be enabled on a forked JVM.</p> 
    </note> 
    <note> 
     <p>The Adobe distribution of the NotSoSerial agent jar can be found in the <span class="code">crx-quickstart/opt/notsoserial/</span> folder of your AEM installation.</p> 
    </note></li> 
   <li><p>Stop and restart the JVM;<br /> </p> </li> 
   <li><p>Verify the agent's activation again by following the steps described above in <a href="../../../sites/administering/using/mitigating-serialization-issues.md#main-pars-title-304897080">Verifying The Agent's Activation</a>.</p> </li> 
  </ol> 
  <h2>Other Considerations</h2> 
  <p>If you are running on an IBM JVM, please review the documentation on support for the Java Attach API at <a href="https://www.ibm.com/support/knowledgecenter/SSSTCZ_2.0.0/com.ibm.rt.doc.20/user/attachapi.html">this location</a>.<br /> </p>    
 </body> 
</html>