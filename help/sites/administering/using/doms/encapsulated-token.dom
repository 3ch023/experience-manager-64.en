<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="2018-04-03T07:03:24.455-0400" name="topicBrowsingSortDate" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;topic_tags:Security;content_type:reference" name="cq:tags" /> 
  <meta content="false" name="isReadyForLocalization" /> 
  <meta content="Learn about the Encapsulated Token support in AEM." name="seoDescription" /> 
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/administering/using/encapsulated-token.html" name="publishExternalURL" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="qaDate" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="bf4c8200-66fa-4126-a73d-c7e000479acc" name="jcr:predecessors" /> 
  <meta content="Guillaume Carlino" name="contentOwner" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="carlino" name="cq:lastReplicatedBy" /> 
  <meta content="2018-04-03T07:03:24.779-0400" name="cq:lastReplicated" /> 
  <meta content="audience:administering" name="primaryAudienceTag" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="Encapsulated Token Support" name="navTitle" /> 
  <meta content="Encapsulated Token Support" name="jcr:title" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="9b7c60c3-a2fe-486f-8d6b-1adec40a8636" name="jcr:uuid" /> 
  <meta content="2018-04-03T07:03:24.455-0400" name="publishExternalDate" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/administering/morehelp/security;/content/help/en/experience-manager/6-4/sites/administering/morehelp/security" name="moreHelpPaths" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="2017-12-01T19:05:54.684-0500" name="jcr:created" /> 
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="2017-10-31T16:25:07.103-0400" name="firstPublishExternalDate" /> 
  <meta content="2018-04-26T10:13:19.996-0400" name="locHandOffDate" /> 
  <meta content="2018-04-03T07:03:24.455-0400" name="lastPublishExternalDate" /> 
  <meta content="Encapsulated Token Support" name="seoTitle" /> 
  <meta content="/content/docs/en/aem/6-3/administer/security/encapsulated-token" name="qaNotes" /> 
  <meta content="carlino" name="cq:lastModifiedBy" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="Activate" name="cq:lastReplicationAction" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="2018-04-26T10:13:19.996-0400" name="cq:lastModified" /> 
 </head> 
 <body> 
  <h2>Introduction</h2> 
  <p>By default, AEM uses the Token Authentication Handler to authenticate each request. However, in order to serve authentication requests the Token Authentication Handler requires access to the repository for every request. This happens because cookies are used to maintain the authentication state. Logically, the state needs to be persisted in the repository in order to validate subsequent requests. In effect, this means that the authentication mechanism is stateful.</p> 
  <p>This is of particular importance for horizontal scalability. In a multi instances setup like the publish farm depicted below, load balancing cannot be achieved in an optimal manner. With stateful authentication, the persisted authentication state will only be available on the instance where the user is first authenticated.</p> 
  <img imageRotate="0" src="assets/chlimage_1-34.png" /> 
  <p>Take the following scenario as an example:</p> 
  <p>A user may be authenticated on publish instance one, but if a subsequent request goes to publish instance two, that instance does not have that persisted authentication state, because that state was persisted in the repository of publish one and publish two has its own repository.</p> 
  <p>The solution for this is to configure sticky connections at the load balancer level. With sticky connections a user would always be directed to the same publish instance. As a consequence, truly optimal load balancing is not possible.</p> 
  <p>In case a publish instance becomes unavailable, all the users authenticated on that instance will lose their session. This is because repository access is needed to validate the authentication cookie.</p> 
  <h2>Stateless Authentication with the Encapsulated Token</h2> 
  <p>The solution for horizontal scalability is stateless authentication with the use of the new Encapsulated Token support in AEM.<br /> </p> 
  <p>The Encapsulated Token is a piece of cryptography that allows to securely create and validate authentication information offline, without accessing the repository. This way, an authentication request can happen on all the publish instances and with no need for sticky connections. It also has the advantage of improving authentication performance since the repository does not need to be accessed for every authentication request.</p> 
  <p>You can see how this works in a geographically distributed deployment with MongoMK authors and TarMK publish instances below:<br /> </p> 
  <img imageRotate="0" src="assets/chlimage_1-35.png" /> 
  <note> 
   <p></p> 
   <p></p> 
   <p>Please note that the Encapsulated Token is about authentication. It ensures that the cookie can be validated without having to access the repository. However, it is still required that the user exists on all the instances and that the information stored under that user can be accessed by every instance.</p> 
   <p>For example, if a new user is created on publish instance number one, due to the way the Encapsulated Token works, it will be authenticated successfully on publish number two. If the user does not exist on the second publish instance, the request will still not be successful.</p> 
   <p></p> 
   <p></p> 
  </note> 
  <h2>Configuring the Encapsulated Token</h2> 
  <p>There are a few things you need to take into consideration when configuring the Encapsulated Token:</p> 
  <ol> 
   <li>Because of the cryptography involved, all of the instances need to have the same HMAC key. Since AEM 6.3, the key material is no longer stored in the repository, but on the actual filesystem. With this in mind, the best way to replicate the keys is to copy them from the filesystem of the source instance to that of the target instance(s) you want to replicate the keys to. See more info under "Replicating the HMAC key" below.</li> 
   <li>The Encapsulated Token needs to be enabled. This can be done through the Web Console.</li> 
  </ol> 
  <h3>Replicating the HMAC key</h3> 
  <p>The HMAC key is present as a binary property of <span class="code">/etc/key</span> in the repository. You can download it separately by pressing the <strong>view</strong> link next to it:<br /> </p> 
  <img imageRotate="0" src="assets/chlimage_1-36.png" /> 
  <p>In order to replicate the key across instances, you need to:<br /> </p> 
  <ol> 
   <li><p>Access the AEM instance, typically an author instance, that contains the key material to copy;</p> </li> 
   <li><p>Locate the <span class="code">com.adobe.granite.crypto.file</span> bundle in the local file system. For example, under this path:</p> 
    <ul> 
     <li>&amp;lt;author-aem-install-dir&amp;gt;/crx-quickstart/launchpad/felix/bundle21</li> 
    </ul> <p>The <span class="code">bundle.info</span> file inside each folder will identify the bundle name.<code class="code">
      <discoiqbr /> </code></p> </li> 
   <li><p>Navigate to the data folder. For example:<br /> </p> 
    <ul> 
     <li><span class="code">&amp;lt;author-aem-install-dir&amp;gt;/crx-quickstart/launchpad/felix/bundle21/data</span></li> 
    </ul> </li> 
   <li><p>Copy the HMAC and master files.</p> </li> 
   <li><p>Then, go to the target instance you want to duplicate the HMAC key to, and navigate to the data folder. For example:</p> 
    <ul> 
     <li><span class="code">&amp;lt;publish-aem-install-dir&amp;gt;/crx-quickstart/launchpad/felix/bundle21/data</span></li> 
    </ul> </li> 
   <li><p>Paste the two files you previously copied.</p> </li> 
   <li><p><a href="../../../communities/using/deploy-communities.md#refreshthegranitecryptobundle" target="_blank">Refresh the Crypto Bundle</a> if the target instance is already running.<br /> </p> </li> 
   <li><p>Repeat the above steps for all instances you want to replicate the key to.<br /> </p> </li> 
  </ol> 
  <h4>Enabling the Encapsulated Token</h4> 
  <p>Once the HMAC key has been replicated, you can enable the Encapsulated Token via the Web Console:<br /> </p> 
  <ol> 
   <li><p>Point your browser to <span class="code">http://serveraddress:port/system/console/configMgr</span></p> </li> 
   <li><p>Look for an entry called <strong>Day CRX Token Authentication</strong> <strong>Handler</strong> and click it.</p> </li> 
   <li><p>In the following window, tick the <strong>Enable encapsulated token support</strong> box and press <strong>Save</strong>.</p> </li> 
  </ol> 
 </body> 
</html>