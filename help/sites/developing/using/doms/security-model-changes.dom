<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
  <meta content="2017-10-31T16:16:18.905-0400" name="lastPublishExternalDate" /> 
  <meta content="audience:developing" name="primaryAudienceTag" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="Security Changes in CQ 5.3 and CRX 2.0" name="navTitle" /> 
  <meta content="975a523f-a1db-48b1-9b0f-edb83287091b" name="jcr:uuid" /> 
  <meta content="Guillaume Carlino" name="contentOwner" /> 
  <meta content="2017-10-31T16:16:18.905-0400" name="firstPublishExternalDate" /> 
  <meta content="2018-08-13T06:05:19.428-0400" name="cq:lastModified" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;topic_tags:platform;content_type:reference" name="cq:tags" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="Deactivate" name="cq:lastReplicationAction" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/developing/morehelp/platform;/content/help/en/experience-manager/6-4/sites/developing/morehelp/platform" name="moreHelpPaths" /> 
  <meta content="2018-05-03T11:09:28.729-0400" name="unpublishExternalDate" /> 
  <meta content="2017-12-01T19:07:09.150-0500" name="jcr:created" /> 
  <meta content="/content/docs/en/aem/6-3/develop/platform/security-model-changes" name="qaNotes" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="2017-11-27T03:17:08.477-0500" name="locHandOffDate" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="remove-legacypath-6-1" name="jcr:lastModifiedBy" /> 
  <meta content="Security Changes in CQ 5.3 and CRX 2.0" name="jcr:title" /> 
  <meta content="trushton" name="cq:lastReplicatedBy" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="qaDate" /> 
  <meta content="" name="publishExternalURL" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="Changes have been made to the security model between CRX 1.4.x and CRX 2.0 - and therefore between AEM 5.2 and AEM 5.3" name="seoDescription" /> 
  <meta content="trushton" name="cq:lastModifiedBy" /> 
  <meta content="2018-05-03T11:09:28.822-0400" name="cq:lastReplicated" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="trushton@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="46b4deb0-06eb-4ed2-a244-f656d5cec8b9" name="jcr:predecessors" /> 
  <meta content="Security Changes in CQ 5.3 and CRX 2.0" name="seoTitle" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" /> 
 </head> 
 <body>   
  <p>Changes have been made to the security model between CRX 1.4.x and CRX 2.0 - and therefore between CQ 5.2 and CQ 5.3. The upgrade procedure compensates for most of these changes and so for most installations, no further action is necessary.</p> 
  <p>However, some changes could not be covered by the upgrade procedure but may affect<br /> some existing installations. This list is provided to cover such changes:</p> 
  <note> 
   <p>This page describes security concepts in a very detailed manner and requires a good understanding of the security model of CQ5 versions prior to 5.3 and CRX versions prior to 2.0, knowledge of the new JCR 2.0 standard in the area of Access Control Management, knowledge about the new security/ACL/user management APIs in Jackrabbit 2.0 and last but not least some general developer knowledge.</p> 
   <p>It is intended as a supporting resource in the case of questions related to an upgrade to CQ 5.3 / CRX 2.0 in the area of Security.</p> 
  </note> 
  <h3>Access Control Evaluation</h3> 
  <p>The Access Control Evaluation (ACE) changed from CRX 1.4.x to CRX 2.0. The major changes are as follows:</p> 
  <p>CRX 1.4.x</p> 
  <ul> 
   <li>ACEs are strictly evaluated based on their order in the Access Control List (ACL).</li> 
   <li>Local ACEs take precedence over hierarchically distant ACEs.</li> 
   <li>When editing in the GUI, ACEs for users are inserted in the ACL so that they take precedence over ACEs for group principals. This can be changed be reordering ACEs.</li> 
   <li>Redundant ACEs can be created and are not cleared from the Access Control implementation. The evaluation order decides on the final result. The clean up is executed by the UI helper classes.</li> 
  </ul> 
  <p>CRX 2.0</p> 
  <ul> 
   <li>ACEs for user principals always take precedence over group principal ACEs, irrespective of: 
    <ul> 
     <li>their order in the ACL <br /> </li> 
     <li>their position in the node hierarchy</li> 
    </ul> </li> 
   <li>For a given principal there exists at most 1 deny and 1 allow entry at a given node. The implementation always clears redundant entries and makes sure that the same privilege is not listed in the allow and in the deny.<br /> </li> 
  </ul> 
  <p>For example:<br /> </p> 
  <p>User <span class="code">aUser</span> who is member of the group <span class="code">aGroup</span>:</p> 
  <codeblock gutter="true" class="syntax xml">
    &amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;parentNode!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;acl!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;ace:&amp;nbsp;aUser&amp;nbsp;-&amp;nbsp;deny&amp;nbsp;-&amp;nbsp;write!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;childNode!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;acl!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;ace:&amp;nbsp;aGroup&amp;nbsp;-&amp;nbsp;allow&amp;nbsp;-&amp;nbsp;write!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;grandChildNode!!discoiqbr!! 
  </codeblock> 
  <p>In the previous case:</p> 
  <ul> 
   <li>CRX 1.4: 
    <ul> 
     <li><span class="code">aUser</span> is granted write permission on <span class="code">grandChildNode.</span></li> 
    </ul> </li> 
   <li>CRX 2.0: 
    <ul> 
     <li><span class="code">aUser</span> is not granted write permission on <span class="code">grandChildNode</span>.<br /> </li> 
    </ul> </li> 
  </ul> 
  <codeblock gutter="true" class="syntax xml">
    &amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;parentNode!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;acl!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;ace:&amp;nbsp;aUser&amp;nbsp;-&amp;nbsp;deny&amp;nbsp;-&amp;nbsp;write!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;childNode!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;acl!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;ace:&amp;nbsp;aGroup&amp;nbsp;-&amp;nbsp;allow&amp;nbsp;-&amp;nbsp;write!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;ace:&amp;nbsp;aUser&amp;nbsp;-&amp;nbsp;deny&amp;nbsp;-write!!discoiqbr!!&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;+&amp;nbsp;grandChildNode 
  </codeblock> 
  <p>In this case:</p> 
  <ul> 
   <li>CRX 1.4: 
    <ul> 
     <li>write permission for <span class="code">aUser</span> on <span class="code">grandChildNode</span> depends on the order of ACEs on <span class="code">childNode</span>.</li> 
    </ul> </li> 
   <li>CRX 2.0: 
    <ul> 
     <li><span class="code">aUser</span> is not granted write permission on <span class="code">grandChildNode</span>.<br /> </li> 
     <li>The second ACE for <span class="code">aUser</span> is redundant.<br /> <br /> </li> 
    </ul> </li> 
  </ul> 
  <h3>Mapping of Former CRX ActionSet to New JCR Privileges</h3> 
  <p>The current mappings are defined in <span class="code">CqActions</span> code module and were selected as the closest match to the previous mappings:<br /> </p> 
  <table border="1" cellpadding="1" cellspacing="0" width="400"> 
   <tbody> 
    <tr> 
     <td><strong>ActionSet</strong></td> 
     <td><strong>JCR Privilege(s)</strong></td> 
     <td><strong>Match</strong></td> 
     <td><strong>Comment</strong></td> 
    </tr> 
    <tr> 
     <td>read</td> 
     <td>JCR_READ</td> 
     <td>+</td> 
     <td> </td> 
    </tr> 
    <tr> 
     <td>set_property</td> 
     <td>JCR_MODIFY_PROPERTIES<br /> JCR_LOCK_MANAGEMENT<br /> JCR_VERSION_MANAGEMENT</td> 
     <td>+-</td> 
     <td><a href="#1">[1]</a></td> 
    </tr> 
    <tr> 
     <td>add_node</td> 
     <td>JCR_ADD_CHILD_NODES<br /> JCR_NODE_TYPE_MANAGEMENT</td> 
     <td>+</td> 
     <td><a href="#2">[2]</a></td> 
    </tr> 
    <tr> 
     <td>remove</td> 
     <td>JCR_REMOVE_CHILD_NODES<br /> JCR_REMOVE_NODE</td> 
     <td>+-</td> 
     <td><a href="#3">[3]</a></td> 
    </tr> 
    <tr> 
     <td>acl_read</td> 
     <td>JCR_READ_ACCESS_CONTROL</td> 
     <td>+</td> 
     <td> </td> 
    </tr> 
    <tr> 
     <td>acl_edit</td> 
     <td>JCR_MODIFY_ACCESS_CONTROL</td> 
     <td>+</td> 
     <td> </td> 
    </tr> 
    <tr> 
     <td>-<br /> -</td> 
     <td>JCR_LIFECYCLE_MANAGEMENT<br /> JCR_RETENTION_MANAGEMENT</td> 
     <td>-<br /> -</td> 
     <td><a href="#4">[4]<br /> [4]</a></td> 
    </tr> 
    <tr> 
     <td>sudo</td> 
     <td>-</td> 
     <td>-</td> 
     <td><a href="#5">[5]</a></td> 
    </tr> 
    <tr> 
     <td>workspaceAccess</td> 
     <td>-</td> 
     <td>-</td> 
     <td><a href="#6">[6]</a></td> 
    </tr> 
   </tbody> 
  </table> 
  <p>The following table shows the mapping of CQActions versus CRX 1.4 ActionSet. The mapping between CQActions and the CRX 1.4 ActionSet was 1:1 and formerly defined in <span class="code">AclRecord.js</span>.<br /> </p> 
  <table border="1" cellpadding="1" cellspacing="0" width="400"> 
   <tbody> 
    <tr> 
     <td><strong>CQAction</strong></td> 
     <td><strong>CRX ActionSet</strong></td> 
    </tr> 
    <tr> 
     <td>read</td> 
     <td>read</td> 
    </tr> 
    <tr> 
     <td>modify</td> 
     <td>set_property</td> 
    </tr> 
    <tr> 
     <td>create</td> 
     <td>add_node</td> 
    </tr> 
    <tr> 
     <td>delete</td> 
     <td>remove</td> 
    </tr> 
    <tr> 
     <td>acl_read</td> 
     <td>acl_read</td> 
    </tr> 
    <tr> 
     <td>acl_edit</td> 
     <td>acl_edit</td> 
    </tr> 
   </tbody> 
  </table> 
  <p><strong>[1]</strong> The set_property ActionSet matches to JCR_MODIFY_PROPERTIES.</p> 
  <p>With CRX 2.0, protected items are no longer checked with the regular permission-check but need to be covered with special privileges that determine whether a given operation that modifies protected items can be executed.</p> 
  <p>To produce the same effect before, JCR_LOCK_MANAGEMENT and JCR_VERSION_MANAGEMENT (both writing protected properties) are automatically granted in CQ if a user is granted modify properties.</p> 
  <p>The JCR_MODIFY_PROPERTIES not only covers the creation of new properties and modification of existing ones but also of property removal. see <a href="#3">[3]</a>.</p> 
  <p><strong>Note:</strong> If a user is granted JCR_MODIFY_PROPERTIES, but not the other two privileges, the "Modify" action in the CQ page permission flag displays <strong>false</strong> even if the user is allowed to add/set/remove regular JCR properties.</p> 
  <p><strong>[2]</strong> The add_node ActionSet matches to JCR_ADD_CHILD_NODES.</p> 
  <p>Because JCR_NODE_TYPE_MANAGEMENT is necessary to be able to write the protected properties jcr:primaryType and jcr:mixinTypes, the latter is included in the mapping to grant both permissions to call Node.addNode(String) and Node.addNode(String, String).</p> 
  <p>In CRX 1.4, <strong>create</strong> not only included the right to add child nodes, but also entitled the user to write properties as long as the new node was not persisted. In CRX 2.0, this is no longer the case. The privilege to write non-protected properties is covered by JCR_MODIFY_PROPERTIES only.</p> 
  <p><strong>[3]</strong> The CRX 1.4 remove ActionSet removed the node in the ACE where the ActionSet was located and all child nodes and their properties. To remove a node in CRX 2.0, the editing session must have JCR_REMOVE_CHILD_NODES on the parent node and on the node that is being removed JCR_REMOVE_NODE. Removing properties is governed by the JCR_MODIFY_PROPERTIES privilege.</p> 
  <p>The <strong>remove</strong> ActionSet defined by CRX and its corresponding ActionSet in CQ is mapped to both JCR privileges JCR_REMOVE_CHILD_NODES and JCR_REMOVE_NODE.</p> 
  <p>This slightly changes the result:</p> 
  <ul> 
   <li>The target node where the two privileges are granted cannot be removed anymore.</li> 
   <li>Child nodes of the target can be removed (same as before).</li> 
   <li>Properties present with the target and its child nodes cannot be removed unless JCR_MODIFY_PROPERTIES is granted.</li> 
  </ul> 
  <p><strong>Example:</strong></p> 
  <p>A user <span class="code">aUser</span> is granted the CQ delete page permission at <span class="code">/foo</span>.</p> 
  <p>CRX 1.4:<span class="code"></span></p> 
  <p><strong>delete</strong> is translated to <strong>remove</strong> ActionSet in CRX 1.4.<code class="code">
    <discoiqbr /> aUser</code> is allowed to remove<span class="code"> /foo</span> and <span class="code">/foo/*</span> and all properties.</p> 
  <p>CRX 2.0:</p> 
  <p><span class="code">aUser</span> is allowed to remove all nodes that match <span class="code">/foo/*</span> but not <span class="code">/foo</span> nor any properties such as <span class="code">/foo/prop</span> nor <span class="code">/foo/*/prop</span>.</p> 
  <p><strong>[4]</strong> The JCR privileges JCR_LIFECYCLE_MANAGEMENT and JCR_RETENTION_MANAGEMENT have no correspondents in CRX 1.4.</p> 
  <p>They have intentionally been omitted from the mapping. The JCR_LIFECYCLE_MANAGEMENT is not used within the scope of CQ, and the JCR_RETENTION_MANAGEMENT privilege is expected to be present and used with defined retention management tools only and not within a regular CQ instance that does not offer retention management functionality.</p> 
  <p><strong>[5]</strong> The sudo ActionSet available in CRX 1.4 has been eliminated in CRX 2.0.</p> 
  <p>With CRX 2.0, a user <strong>A</strong> can impersonate a user <strong>B</strong> if the principal name of <strong>A</strong> is listed in the <strong>rep:impersonators</strong> property of user <strong>B</strong>.</p> 
  <p><strong>[6]</strong> The workspaceAccess ActionSet available in CRX 1.4 has been eliminated in CRX 2.0. With CRX 2.0, access to a given workspace is granted if the configured WorkspaceAccessManager implementation grants access.</p> 
  <p>The default implementation of CRX and CQ grants workspace access only if the user is known to the UserManager defined for that workspace.<br /> </p> 
  <p>Alternative implementations are as follows:<br /> </p> 
  <ul> 
   <li>SimpleWorkspaceAccessManager: Always granting access.</li> 
   <li>DefaultSecurityManager#WorkspaceAccessManagerImpl: Granting<br /> access if the root node is visible to a given user.<br /> </li> 
  </ul> 
  <h3>CRX Access Control API</h3> 
  <p>The access control API available in CRX 1.x has been replaced by interfaces defined by JSR 283 and some extensions defined by the Jackrabbit API.</p> 
  <h3>AclSetupService</h3> 
  <p>As of CQ 5.3, run-mode dependent default permissions can be defined with the AclSetupService that always runs during startup.</p> 
  <p>The AclSetupService allows you to specify access control entries to be created at a given path for a given principal name. In addition, it allows you to clear existing entries at a given path for a given principal name.</p> 
  <p>Because of the nature of the service, this may potentially cause issues with existing access control content.</p> 
 </body> 
</html>