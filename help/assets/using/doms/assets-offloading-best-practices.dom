<?xml version="1.1" encoding="UTF-8" standalone="yes"?>
<html>
 <head>
  <meta content="/apps/help/templates/article-3" name="cq:template" />
  <meta content="/etc/designs/help" name="cq:designPath" />
  <meta content="Assets Offloading Best Practices" name="seoTitle" />
  <meta content="1763" name="acrolinxWords" />
  <meta content="Assets Offloading Best Practices" name="jcr:title" />
  <meta content="Chiradeep Majumdar" name="contentOwner" />
  <meta content="" name="jcr:primaryType" />
  <meta content="/content/help/en/experience-manager/6-4/assets/morehelp/administering;/content/help/en/experience-manager/6-4/assets/morehelp/administering" name="moreHelpPaths" />
  <meta content="" name="jcr:versionHistory" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/ASSETS;topic_tags:administering;content_type:reference" name="cq:tags" />
  <meta content="Recommended use cases and best practices for offloading asset ingestion and replication workflows in AEM Assets." name="seoDescription" />
  <meta content="2018-04-03T08:04:08.401-0400" name="cq:lastReplicated" />
  <meta content="help/components/pages/article-3" name="sling:resourceType" />
  <meta content="2017-10-12T21:46:00.000-0400" name="qaDate" />
  <meta content="2019-01-12T17:12:44.479-0500" name="acrolinxDate" />
  <meta content="carlino" name="cq:lastReplicatedBy" />
  <meta content="2017-12-01T19:05:42.049-0500" name="jcr:created" />
  <meta content="cmajumda@adobe.com" name="lr_lastReplicatedBy" />
  <meta content="yellow" name="acrolinxPageStatus" />
  <meta content="2017-11-22T10:46:58.523-0500" name="topicBrowsingSortDate" />
  <meta content="carlino" name="cq:lastModifiedBy" />
  <meta content="mix:versionable" name="jcr:mixinTypes" />
  <meta content="en_us" name="jcr:language" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/ASSETS" name="primaryProductTag" />
  <meta content="135" name="acrolinxSentences" />
  <meta content="Activate" name="cq:lastReplicationAction" />
  <meta content="3e99ef42-9c45-4a3e-b495-5c6984f81623" name="jcr:predecessors" />
  <meta content="" name="jcr:baseVersion" />
  <meta content="2018-04-24T11:59:33.263-0400" name="locHandOffDate" />
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" />
  <meta content="admin" name="jcr:createdBy" />
  <meta content="2017-11-22T10:46:58.523-0500" name="lastPublishExternalDate" />
  <meta content="2017-11-22T10:46:58.523-0500" name="publishExternalDate" />
  <meta content="http://acrolinx.corp.adobe.com:8031/output/en/assets_offloading_best_practices_krs_workflow_f3c2f2ccebf6138e_97_report.xml" name="acrolinxReportURL" />
  <meta content="true" name="jcr:isCheckedOut" />
  <meta content="asgupta" name="acrolinxLastCheckedBy" />
  <meta content="false" name="isReadyForLocalization" />
  <meta content="2017-10-31T16:35:21.160-0400" name="firstPublishExternalDate" />
  <meta content="cbc7214f-d5d6-4dda-9ba3-53820ae09b27" name="jcr:uuid" />
  <meta content="checked_not_improved" name="acrolinxStatus" />
  <meta content="/content/docs/en/aem/6-3/administer/content/assets/best-practices-for-assets/assets-offloading-best-practices" name="qaNotes" />
  <meta content="2018-04-24T11:59:33.263-0400" name="cq:lastModified" />
  <meta content="https://helpx.adobe.com/experience-manager/6-3/assets/using/assets-offloading-best-practices.html" name="publishExternalURL" />
 </head>
 <body>
  <h2>Overview</h2>
  <p>Handling large files and running workflows in Adobe Experience Manager (AEM) Assets can consume considerable CPU, memory, and I/O resources. In particular, the size of assets, workflows, number of users, and frequency of asset ingestion can affect the overall system performance. The most resource-intensive operations include AEM asset ingestion and replication workflows. Intensive use of these workflows on a single AEM authoring instance can adversely impact authoring efficiency.</p> 
  <p>Offloading these tasks to dedicated worker instances can reduce CPU, memory, and IO overheads. In general, the idea behind offloading is to distribute tasks that consume intensive CPU/Memory/IO resources to dedicated worker instances. The following sections include recommended use cases for Assets offloading. </p> 
  <h2>AEM Assets Offloading</h2>
  <p>AEM Assets implements a native asset-specific workflow extension for offloading. It builds on the generic workflow extension that the offloading framework provides, but includes additional assets-specific features in the implementation. The goal of Assets offloading is to efficiently run the DAM Update Asset workflow on an uploaded asset. Assets offloading enables you to gain greater control of the ingestion workflows.</p> 
  <h2>AEM Assets Offloading Components</h2>
  <p>The following diagram depicts the main components in Asset offloading process:</p> 
  <img imageRotate="0" src="assets/chlimage_1-55.png" />
  <h3>DAM Update Asset Offloading workflow</h3>
  <p>The DAM Update Asset Offloading workflow runs on the master (author) where the user uploads the assets. This workflow is triggered by a regular workflow launcher. Instead of processing the uploaded asset, this offloading workflow creates a new job, using the topic <i>com/adobe/granite/workflow/offloading</i>. The offloading workflow adds the name of the target workflow -the DAM Update Asset workflow in this case, and the path of the asset to the job's payload. After creating the offloading job, the offloading workflow on the master waits until the offloading job has run.</p> 
  <h3>Job manager</h3>
  <p>The job manager distributes new jobs to worker instances. When designing the distribution mechanism, it is important to take topic enablement into account. Jobs can only be assigned to instances where the job's topic is enabled. Disable the topic <i>com/adobe/granite/workflow/offloading</i> on the master, and enable it on the worker to ensure that the job is assigned to the worker.</p> 
  <h3>AEM offloading</h3>
  <p>The offloading framework identifies workflow offloading jobs assigned to worker instances and uses replication to physically transport them, including their payload (for example, images to be ingested), to workers.</p> 
  <h3>Workflow offloading job consumer</h3>
  <p>Once a job is written on the worker, the job manager calls the job consumer responsible for the <i>com/adobe/granite/workflow/offloading</i> topic. The job consumer then runs the DAM Update Asset workflow on the asset.</p> 
  <h2>Sling Topology</h2>
  <p>The Sling topology groups AEM instances and enables them to be aware of each other, independent of the underlying persistence. This characteristic of the Sling topology lets you create topologies for non-clustered, clustered, and mixed scenarios. An instance can expose properties to the entire topology. The framework provides callbacks for listening to changes in the topology (instances and properties). Sling topology provides the foundation for Sling distributed jobs.</p> 
  <h3>Sling distributed jobs</h3>
  <p>Sling distributed jobs facilitate the distribution of jobs among a set of instances that are members of the topology. Sling jobs are based on the idea of capabilities. A job is defined by its job topic. To run a job, an instance must provide a job consumer for a specific job topic. The job topic is the main driver for the distribution mechanism.</p> 
  <p>Jobs are only distributed to instances that provide a job consumer for the topic. By enabling/disabling job consumers on an instance, you can define the capabilities of an instance and influence the distribution mechanism. The available job consumers of an instance are broadcast to the whole topology.</p> 
  <p>In this context, the term distribution signifies assignment of a job to a specific instance that provides a job consumer. The assignment to an instance is stored in the repository. In other words, Sling distributed jobs can be assigned to any instance in the topology by default. However, other jobs can only be run by instances that share the same repository. This implies that these jobs can only be run by instances that are part of the same cluster. Jobs assigned to instances of a different cluster are not run.</p> 
  <h3>Granite offloading framework</h3>
  <p>The Granite offloading framework complements Sling job distribution to run jobs that are assigned to non-clustered instances. It does not perform any distribution (instance assignment). However, it identifies Sling jobs that were distributed to non-clustered instances, and transports them to the target instance for execution. Currently, offloading uses replication to perform this job transport. To run a job, offloading defines the input and the output, which are then combined with the job to build the job payload.</p> 
  <p>Sling distributed jobs provide the job and distribution framework. Granite offloading only takes care of the transport for the special case where jobs are distributed to non-clustered instances.</p> 
  <p>In addition to transport, the offloading framework provides an extension for the workflow engine. It allows the framework to create distributed jobs as part of a workflow and wait for their completion, before the workflow advances. It is implemented using the workflow external step API from the workflow engine. One of the extensions facilitates generic distribution of workflows. Distributing single workflow steps is not supported. </p> 
  <p>The offloading framework also comes with a user interface (UI) to visualize and control job topic enablement across the entire topology. The UI lets you conveniently configure the topic enablemenet of Sling distributed jobs. You can also set up offloading without the UI.</p> 
  <h2>General Guidance and Best Practices for Asset Offloading</h2>
  <p>Every implementation is unique and, as such, there is no one-size-fits-all offloading configuration. The following sections provide guidance and best practises around asset ingestion offloading.</p> 
  <p>Asset offloading also imposes overheads on the system, including operation overheads. If you encounter issues with the asset ingestion load, Adobe recommends that you first improve the configuration without offloading. Consider the following options before moving to asset offloading:</p> 
  <ul> 
   <li>Scale up hardware</li> 
   <li>Optimize workflows</li> 
   <li>Use transient workflows</li> 
   <li>Limit the number of cores used for workflows </li> 
  </ul> 
  <p>If you conclude that Assets offloading is an appropriate approach for you, Adobe provides the following guidance:</p> 
  <ul> 
   <li>A TarMK-based deployment is recommended</li> 
   <li>TarMK-based Assets offloading is not designed for extensive horizontal scaling</li> 
   <li>Ensure that network performance between the author and workers is satisfactory</li> 
  </ul> 
  <h3>Recommended Assets offloading deployment</h3>
  <p>With AEM and Oak, there are several deployment scenarios possible. For Assets offloading, a TarMK based deployment with a shared datastore is recommended. The following diagram outlines the recommended deployment:</p> 
  <img imageRotate="0" src="assets/chlimage_1-56.png" />
  <p>For details around configuring a datastore, see <a href="../../sites/deploying/using/data-store-config.md">Configuring node stores and data stores in AEM</a>.</p> 
  <h3>Turning off automatic agent management</h3>
  <p>Adobe recommends that you turn off automatic agent management because it does not support binary-less replication and can cause confusion when setting up a new offloading topology. Moreover, it does not automatically support the forward replication flow required by binary-less replication.</p> 
  <ol>
   <li><p>Open Configuration Manager from the URL <i>http://localhost:4502/system/console/configMgr</i>. </p> </li>
   <li><p>Open the configuration for OffloadingAgentManager (<i>http://localhost:4502/system/console/configMgr/com.adobe.granite.offloading.impl.transporter.OffloadingAgentManager</i>).</p> </li>
   <li><p>Disable automatic agent management.</p> </li>
  </ol>
  <h3>Using forward replication</h3>
  <div>
   By default, offloading transport uses reverse replication to pull back the offloaded assets from the worker to the master. Reverse replication agents do not support binary-less replication. You should configure offloading to use forward replication to push the offloaded assets back from worker to master.
  </div> 
  <ol>
   <li><p>If you are migrating from the default configuration using reverse replication, disable or delete all agents named "<span class="code">offloading_outbox</span>" and "<span class="code">offloading_reverse_*</span>" on master and worker, where * represents the Sling id of the target instance.</p> </li>
   <li><p>On each worker, create new forward replication agent pointing to the master. The procedure is the same as creating forward agents from master to worker. See <a href="../../sites/deploying/using/offloading.md#creatingreplicationagentsforoffloading">Creating Replication Agents For Offloading</a> for instructions around setting up offloading replication agents.</p> </li>
   <li><p>Open configuration for OffloadingDefaultTransporter (<i>http://localhost:4502/system/console/configMgr/com.adobe.granite.offloading.impl.transporter.OffloadingDefaultTransporter</i>).</p> </li>
   <li><p>Change value of the property <span class="code">default.transport.agent-to-master.prefix</span> from <i>offloading_reverse</i> to <i>offloading</i>.</p> </li>
  </ol>
  <h3>Using shared datastore and binary-less replication between author and workers </h3>
  <p>The use of binary-less replication is recommendend to reduce the transport overhead for asset offloading. To know how to set up binary-less replication for a shared datastore, see <a href="../../sites/deploying/using/data-store-config.md">Configuring Node Stores and Data Stores in AEM</a>. The procedure is not different for Assets offloading, except that it involves other replication agents. Because binary-less replication only works with forward replication agents, you should also use forward replication for all offloading agents.</p> 
  <h3>Turning off transport packages</h3>
  <p>By default, offloading creates a content package that contains the offloading job and job payload (the original asset), and transports this single offloading package using a single replication request. Creating these offloading packages is counter productive when using binary-less replication, because binaries are serialized into the package again when creating the package. The use of these transport packages can be turned off, which causes the offloading job and payload be transported in multiple replication requests, one for each payload entry. This way, the benefit of binary-less replication can be utilized.</p> 
  <ol>
   <li><p>Open the component configuration of <i>OffloadingDefaultTransporter</i> component at <a href="http://localhost:4502/system/console/configMgr/com.adobe.granite.offloading.impl.transporter.OffloadingDefaultTransporter">http://localhost:4502/system/console/configMgr/com.adobe.granite.offloading.impl.transporter.OffloadingDefaultTransporter</a></p> </li>
   <li><p>Disable the property <i>Replication Package (default.transport.contentpackage)</i>.</p> </li>
  </ol>
  <h3>Disabling the transport of workflow model</h3>
  <p>By default, the <i>DAM Update Asset Offloading</i> offloading workflow adds the workflow model to call on the worker to the job payload. Because this workflow follows the out-of-the-box <i>DAM Update Asset</i> model by default, this additional payload can be removed.</p> 
  <p>If the workflow model is disabled from the job payload, ensure that you distribute changes to the referenced workflow model using other tools, such as package manager.</p> 
  <p>To disable the transport of the workflow model, modify the DAM Update Asset Offloading workflow.</p> 
  <ol>
   <li><p>Open the workflow console from <a href="http://localhost:4502/libs/cq/workflow/content/console.html">http://localhost:4502/libs/cq/workflow/content/console.html</a>.</p> </li>
   <li><p>Open the Models tab.</p> </li>
   <li><p>Open the DAM Update Asset Offloading workflow model.</p> </li>
   <li><p>Open step properties for the DAM Workflow Offloading step.</p> </li>
   <li><p>Open the Arguments tab, and unselect the Add Model To Input and Add Model To Output options.</p> </li>
   <li><p>Save the changes to the model.</p> </li>
  </ol>
  <h3>Optimizing the polling interval</h3>
  <p>Workflow offloading is implemented using an external workflow on the master, that polls for the completion of the offloaded workflow on the worker. The default polling interval for the external workflow processes is five seconds. Adobe recommends that you increase the polling interval of the Assets offloading step to at least 15 seconds to reduce the offloading overhead on the master.</p> 
  <ol>
   <li><p>Open the workflow console from <a href="http://localhost:4502/libs/cq/workflow/content/console.html">http://localhost:4502/libs/cq/workflow/content/console.html</a>.<br /> </p> </li>
   <li><p>Open the Models tab.</p> </li>
   <li><p>Open the DAM Update Asset Offloading workflow model.</p> </li>
   <li><p>Open the step properties for the DAM Workflow Offloading step.</p> </li>
   <li><p>Open the Commons tab, and adjust the value of the Period property.</p> </li>
   <li><p>Save the changes to the model.</p> </li>
  </ol>
  <h2>More Resources</h2>
  <p>This document focuses on Asset Offloading. Here is some additional documentation on offloading:</p> 
  <ul> 
   <li><a href="../../sites/deploying/using/offloading.md">Offloading Jobs</a> </li> 
   <li><a href="../../sites/administering/using/workflow-offloader.md">Assets workflow offloader</a> </li> 
  </ul> 
 </body>
</html>