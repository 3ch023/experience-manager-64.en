<?xml version="1.1" encoding="UTF-8" standalone="yes"?>
<html>
 <head>
  <meta content="207bcf04-e2d9-4aae-8d86-83e53e79c0a6" name="jcr:uuid" />
  <meta content="Guillaume Carlino" name="contentOwner" />
  <meta content="2018-04-03T07:06:37.187-0400" name="lastPublishExternalDate" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;topic_tags:Security;content_type:reference" name="cq:tags" />
  <meta content="2017-10-31T16:22:07.919-0400" name="firstPublishExternalDate" />
  <meta content="/apps/help/templates/article-3" name="cq:template" />
  <meta content="2018-04-03T07:06:37.187-0400" name="publishExternalDate" />
  <meta content="SAML 2.0 Authentication Handler" name="jcr:title" />
  <meta content="" name="jcr:versionHistory" />
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" />
  <meta content="15458d01-0522-46af-91ca-b2fca8b84c08" name="jcr:predecessors" />
  <meta content="true" name="jcr:isCheckedOut" />
  <meta content="2018-12-12T06:18:00.408-0500" name="cq:lastModified" />
  <meta content="" name="jcr:primaryType" />
  <meta content="admin" name="jcr:createdBy" />
  <meta content="en_us" name="jcr:language" />
  <meta content="/etc/designs/help" name="cq:designPath" />
  <meta content="2018-03-15T09:02:28.125-0400" name="jcr:created" />
  <meta content="/content/docs/en/aem/6-3/administer/security/saml-2-0-authenticationhandler" name="qaNotes" />
  <meta content="Learn about the SAML 2.0 Authentication Handler in AEM." name="seoDescription" />
  <meta content="SAML 2.0 Authentication Handler" name="navTitle" />
  <meta content="2018-04-03T07:06:37.187-0400" name="topicBrowsingSortDate" />
  <meta content="sarchiz" name="cq:lastReplicatedBy" />
  <meta content="2017-10-12T21:46:58.665-0400" name="qaDate" />
  <meta content="" name="jcr:baseVersion" />
  <meta content="sarchiz" name="cq:lastModifiedBy" />
  <meta content="false" name="isReadyForLocalization" />
  <meta content="audience:administering" name="primaryAudienceTag" />
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/administering/using/saml-2-0-authenticationhandler.html" name="publishExternalURL" />
  <meta content="Activate" name="cq:lastReplicationAction" />
  <meta content="SAML 2.0 Authentication Handler" name="seoTitle" />
  <meta content="mix:versionable" name="jcr:mixinTypes" />
  <meta content="help/components/pages/article-3" name="sling:resourceType" />
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" />
  <meta content="remove-legacypath-6-1" name="jcr:lastModifiedBy" />
  <meta content="2018-12-12T10:27:59.199-0500" name="cq:lastReplicated" />
  <meta content="/content/help/en/experience-manager/6-4/sites/administering/morehelp/security;/content/help/en/experience-manager/6-4/sites/administering/morehelp/security" name="moreHelpPaths" />
  <meta content="2018-04-26T10:12:09.036-0400" name="locHandOffDate" />
 </head>
 <body>
  <draft-comment color="yellow" lastModifiedBy="colligno@adobe.com" lastModifiedDate="2018-03-14T13:20:43.299-0400" prevFirstName="unknown" prevLastName="unknown" type="remark">
   <p><strong>Issue</strong> tracked by https://issues.adobe.com/browse/DOC-2769</p> 
   <p>Dev <strong>draft</strong> <a href="https://zerowing.corp.adobe.com/display/granite/SAML+2.0+Authentication+Handler">https://zerowing.corp.adobe.com/display/granite/SAML+2.0+Authentication+Handler</a></p> 
  </draft-comment>
  <p>AEM ships with a <a href="http://saml.xml.org/saml-specifications">SAML</a> authentication handler. This handler provides support for the <a href="http://saml.xml.org/saml-specifications">SAML</a> 2.0 Authentication Request Protocol (Web-SSO profile) using the <span class="code">HTTP POST</span> binding.</p> 
  <p>It supports:</p> 
  <ul> 
   <li>signing and encryption of messages</li> 
   <li>automatic creation of users<br /> </li> 
   <li>synching groups to existsing ones in AEM</li> 
   <li>Service Provider and Identity Provider initiated authentication</li> 
  </ul> 
  <p>This handler stores the encrypted SAML response message in the user-node (<span class="code">usernode/samlResponse</span>) to facilitate communication with a third-party Service Provider.</p> 
  <note>
   <p>See <a href="http://helpx.adobe.com/cq/kb/saml-demo.html">a demonstration of AEM and SAML integration</a>.</p> 
   <p>To read an end to end community article, click: <a href="https://helpx.adobe.com/experience-manager/using/aem63_saml.html" target="_blank">Integrating SAML with Adobe Experience Manager</a>.</p> 
  </note>
  <h2>Configuring The SAML 2.0 Authentication Handler</h2>
  <p>The <a href="../../../sites/deploying/using/configuring-osgi.md">Web console</a> provides access to the <a href="http://saml.xml.org/saml-specifications">SAML</a> 2.0 Authentication Handler configuration called <strong>Adobe Granite SAML 2.0 Authentication Handler</strong>. The following properties can be set.<br /> </p> 
  <note>
   <p>The SAML 2.0 Authentication Handler is disabled by default. You must set at least one of the following properties in order to enable the handler: </p> 
   <ul> 
    <li>The Identity Provider POST URL.<br /> </li> 
    <li>The Service Provider Entity ID.</li> 
   </ul> 
  </note>
  <note>
   <p>SAML assertions are signed and may optionally be encrypted. In order for this to work you have to provide at least the public certificate of the Indentity Provider in the TrustStore. See <a href="../../../sites/administering/using/saml-2-0-authenticationhandler.md#addtheidpcertificatetotheaemtruststore">Adding the IdP certificate to the TrustStore</a> section for more information.</p> 
  </note>
  <p><strong>Path</strong> Repository path for which this authentication handler should be used by Sling. If this is empty, the authentication handler will be disabled.</p>
  <p><strong>Service Ranking</strong> OSGi Framework Service Ranking value to indicate the order in which to call this service. This is an integer value where higher values designate higher precedence.</p>
  <p><strong>IDP Certificate Alias</strong> The alias of the IdP's certificate in the global truststore. If this property is empty the authentication handler is disabled. See the "Add the IdP Certificate to the AEM TrustStore" chapter below on how to set it up.</p>
  <p><strong>Identity Provider URL</strong> URL of the IDP where the SAML Authentication Request should be sent to. If this property is empty the authentication handler is disabled.</p>
  <note>
   <p>The Identity Provider hostname must be added to the <strong>Apache Sling Referrer Filter</strong> OSGi configuration. See the <a href="../../../sites/deploying/using/configuring-osgi.md">Web console</a> section for more information.<br /> </p> 
  </note>
  <p><strong>Service Provider Entity ID</strong> ID which uniquely identifies this service provider with the identity provider. If this property is empty the authentication handler is disabled.</p>
  <p><strong>Default Redirect</strong> The default location to redirect to after successful authentication.</p>
  <note>
   <p>This location is only used if the <span class="code">request-path</span> cookie is not set. If you request any page below the configured path without a valid login-token, the requested path is stored in a cookie<br /> and the browser will be redirected to this location again after successful authentication.</p> 
  </note>
  <p><strong>User-ID Attribute</strong> The name of the attribute containing the user ID used to authenticate and create the user in the CRX repository.</p>
  <note>
   <p>The user ID will not be taken from the <span class="code">saml:Subject</span> node of the SAML assertion but from this <span class="code">saml:Attribute</span>.</p> 
  </note>
  <p><strong>Use Encryption</strong> Whether or not this authentication handler expects encrypted SAML assertions.</p>
  <p><strong>Autocreate CRX Users</strong> Whether or not to automatically create non-existing users in the repository after successful authentication.</p>
  <note>
   <p>If the automatic creation of CRX users is disabled, the users will have to be created manually.</p> 
  </note>
  <p><strong>Add to Groups</strong> Whether or not a user should be automatically added to CRX groups after successful authentication.</p>
  <p><strong>Group Membership</strong> The name of the saml:Attribute containing a list of CRX groups this user should be added to.</p>
  <h2>Add the IdP Certificate to the AEM TrustStore</h2>
  <p>SAML assertions are signed and may optionally be encrypted. In order for this to work you have to provide at least the public certificate of the IdP in the repository. In order to do this you need to:</p> 
  <ol>
   <li><p>Go to: <a href="http://localhost:4502/libs/granite/security/content/useradmin.html">http://localhost:4502/libs/granite/security/content/useradmin.html</a></p> </li>
   <li><p>Click on any of the users in the list.</p> </li>
   <li><p>Go under <strong>Account Settings</strong>, and press the <strong>Create TrustStore</strong> link.</p> </li>
   <li><p>Enter the password for the TrustStore and press <strong>Save</strong>.</p> </li>
   <li><p>Click on <strong>Manage TrustStore</strong>.</p> </li>
   <li><p>Upload the IdP certificate.</p> </li>
   <li><p>Take note of the certificate Alias. The alias is <strong>admin#1436172864930</strong> in the example below.</p> <img imageRotate="0" src="assets/chlimage_1-459.png" /></li>
  </ol>
  <h2>Add the Service Provider key and certificate chain to the AEM keystore</h2>
  <note>
   <p>The below steps are mandatory, otherwise the following exception will be thrown: <span class="code">com.adobe.granite.keystore.KeyStoreNotInitialisedException: Uninitialised system trust store</span></p> 
  </note>
  <ol>
   <li><p>Go to: <a href="http://localhost:4502/libs/granite/security/content/useradmin.html">http://localhost:4502/libs/granite/security/content/useradmin.html</a></p> </li>
   <li><p>Edit the <span class="code">authentication-service</span> user.</p> </li>
   <li><p>Create a KeyStore by clicking <strong>Create KeyStore</strong> under <strong>Account Settings</strong>.</p> </li>
  </ol>
  <note>
   <p>The below steps are required only if handler should be able to sign or decrypt messages.</p> 
  </note>
  <ol>
   <li><p>Upload the Private key file by clicking <strong>Select Private Key File</strong>. The key meeds to be in PKCS#8 format with DER encoding. </p> </li>
   <li><p>Upload the certificate file by clicking <strong>Select Certificate Chain Files</strong>.</p> </li>
   <li><p>Assign an Alias, as shown below:</p> <img imageRotate="0" src="assets/chlimage_1-460.png" /></li>
  </ol>
  <h2>Configure a Logger for SAML</h2>
  <p>You can set up a Logger in order to debug any issues that might arise from misconfiguring SAML. You can do this by:</p> 
  <ol>
   <li><p>Going to the Web Console, at <i>http://localhost:4502/system/console/configMgr</i></p> </li>
   <li><p>Search for and click on the entry called <strong>Apache Sling Logging Logger Configuration</strong></p> </li>
   <li><p>Create a logger with the following configuration:</p> 
    <ul> 
     <li><strong>Log Level:</strong> Debug</li> 
     <li><strong>Log File:</strong> logs/saml.log</li> 
     <li><strong>Logger:</strong> com.adobe.granite.auth.saml</li> 
    </ul> </li>
  </ol>
 </body>
</html>