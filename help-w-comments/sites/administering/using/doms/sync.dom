<?xml version="1.1" encoding="UTF-8" standalone="yes"?>
<html>
 <head>
  <meta content="2017-10-31T16:21:51.351-0400" name="firstPublishExternalDate" />
  <meta content="User Synchronization" name="navTitle" />
  <meta content="2018-04-03T07:07:20.136-0400" name="publishExternalDate" />
  <meta content="en_us" name="jcr:language" />
  <meta content="User Synchronization" name="jcr:title" />
  <meta content="Learn about user synchronization in AEM." name="seoDescription" />
  <meta content="mix:versionable" name="jcr:mixinTypes" />
  <meta content="true" name="jcr:isCheckedOut" />
  <meta content="Guillaume Carlino" name="contentOwner" />
  <meta content="/content/docs/en/aem/6-3/administer/security/security/sync" name="qaNotes" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;topic_tags:Security;content_type:reference" name="cq:tags" />
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" />
  <meta content="" name="jcr:baseVersion" />
  <meta content="carlino" name="cq:lastReplicatedBy" />
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/administering/using/sync.html" name="publishExternalURL" />
  <meta content="/content/help/en/experience-manager/6-4/sites/administering/morehelp/security;/content/help/en/experience-manager/6-4/sites/administering/morehelp/security" name="moreHelpPaths" />
  <meta content="2018-04-03T07:07:20.136-0400" name="lastPublishExternalDate" />
  <meta content="Activate" name="cq:lastReplicationAction" />
  <meta content="audience:administering" name="primaryAudienceTag" />
  <meta content="/etc/designs/help" name="cq:designPath" />
  <meta content="" name="jcr:primaryType" />
  <meta content="3324ea9b-022f-4cd3-9595-30a5fea1fa75" name="jcr:predecessors" />
  <meta content="mgulati" name="cq:lastModifiedBy" />
  <meta content="2018-04-03T07:07:20.136-0400" name="topicBrowsingSortDate" />
  <meta content="2019-01-25T04:00:12.801-0500" name="cq:lastModified" />
  <meta content="admin" name="jcr:createdBy" />
  <meta content="2018-04-03T07:07:20.486-0400" name="cq:lastReplicated" />
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" />
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" />
  <meta content="help/components/pages/article-3" name="sling:resourceType" />
  <meta content="" name="jcr:versionHistory" />
  <meta content="User Synchronization" name="seoTitle" />
  <meta content="false" name="isReadyForLocalization" />
  <meta content="2018-04-26T10:11:52.160-0400" name="locHandOffDate" />
  <meta content="2017-10-12T21:46:58.665-0400" name="qaDate" />
  <meta content="2018-01-13T19:01:57.688-0500" name="jcr:created" />
  <meta content="/apps/help/templates/article-3" name="cq:template" />
  <meta content="3c5b238e-5eef-4fbc-80d9-60ed99404fde" name="jcr:uuid" />
 </head>
 <body>
  <h2>Introduction</h2>
  <p>When the deployment is a <a href="../../../sites/deploying/using/recommended-deploys.md#tarmkfarm">publish farm</a>, members need to be able to log in and see their data on any publish node. </p> 
  <p>Users and user groups (user data) created in the publish environment are not needed in the author environment. </p> 
  <p>Most user data created in the author environment is intended to remain in the author environment and not be copied to publish instances.</p> 
  <p>Registration and modifications made on one publish instance need to be synchronized with other publish instances in order for them to have access to the same user data.</p> 
  <p> As of AEM 6.1, when user synchronization is enabled, user data is automatically synchronized across the publish instances in the farm and are not created on author.</p> 
  <h2>Sling Distribution</h2>
  <p>The user data, along with their <a href="../../../sites/administering/using/security.md">ACLs</a>, are stored in the <a href="../../../sites/deploying/using/platform.md">Oak Core</a>, the layer below Oak JCR, and are accessed using the <a href="/sites/developing/using/reference-materials/javadoc/org/apache/jackrabbit/oak/api/package-tree">Oak API</a>. With infrequent updates, it is reasonable for user data to be synchronized with other publish instances using <a href="https://github.com/apache/sling/blob/trunk/contrib/extensions/distribution/README.md">Sling Content Distribution</a> (Sling distribution).</p> 
  <p>The benefits of user sync using Sling distribution, compared to traditional replication are : </p> 
  <ul> 
   <li><i>users</i>, <i>user profiles</i> and <i>user groups</i> created on publish are not created on author</li> 
   <li>Sling distribution sets properties in jcr events, making it possible to act within publish-side event listeners without concern for infinite replication loops</li> 
   <li>Sling distribution only sends user data to non-originating publish instances, eliminating unnecessary traffic</li> 
   <li><a href="../../../sites/administering/using/security.md">ACLs</a> set in the user node are included in the sychronization</li> 
  </ul> 
  <note>
   <p>If sessions are required, it is recommended to either use an SSO solution or use sticky session and have customers log in if they get switched to another publsher.</p> 
  </note>
  <note>
   <p>Synchronization of the <i><strong>administrators</strong> </i>group is not supported, even when user sync is enabled. Instead, a failure to 'import the diff' will be logged in the error log.</p> 
   <p>Therefore, when the deployment is a publish farm, if a user is added to or removed from the <i><strong>administrators</strong> </i>group, the modification must be manually made on each publish instance.</p> 
  </note>
  <h2>Enable User Sync</h2>
  <draft-comment color="yellow" lastModifiedBy="ims-author-D9FB647253FD17BE0A4C98A6@AdobeID" lastModifiedDate="2018-01-12T05:19:07.315-0500" prevFirstName="unknown" prevLastName="unknown" type="remark">
   <p> <strong> ************ IMPORTANT - PLEASE READ **************</strong></p> 
   <p>All titles in this section are referenced from diagnostic code by GoURLs.</p> 
   <p><strong> navigate to : Tools, Operations, Diagnosis, User Sync Diagnostics</strong></p> 
   <p>If titles are altered, it may affect links to documentation embedded in code.</p> 
   <p><a href="https://jira.corp.adobe.com/browse/DOC-6923">DOC-6923 Health Checker for user sync</a></p> 
   <p><a href="https://wiki.corp.adobe.com/display/aemdoc/AEM+GoURLs">AEM GoURLs wiki</a> : look for URLs prefixed with <i>aem6_2_docs_usersync_enable</i></p> 
  </draft-comment>
  <note>
   <p>By default, user sync is <span class="code">disabled</span>.</p> 
   <p>Enabling user sync involves modifying <em>existing</em> OSGi configurations.</p> 
   <p>No new configurations should be added as a result of enabling user sync.</p> 
  </note>
  <p>User sync relies on the 
   <g class="gr_ gr_8 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" data-gr-id="8" id="8">
    author
   </g> environment to manage the user data distributions, even though the user data is not created on 
   <g class="gr_ gr_6 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar only-ins doubleReplace replaceWithoutSep" data-gr-id="6" id="6">
    author
   </g>. Much, but not all, of the 
   <g class="gr_ gr_10 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep" data-gr-id="10" id="10">
    configuration
   </g> takes place in the 
   <g class="gr_ gr_9 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" data-gr-id="9" id="9">
    author
   </g> environment and each step clearly identifies whether it is to be performed on 
   <g class="gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar only-ins replaceWithoutSep" data-gr-id="7" id="7">
    author
   </g> or publish.</p> 
  <p>Following are the steps necessary to enable user synchronization, followed by a <a href="#troubleshooting">Troubleshooting</a> section :</p> 
  <h3>Prerequisites</h3>
  <p>1) If users and user groups have already been created on one publisher, it is recommended to <a href="#manuallysyncingusersandusergroups">manually sync</a> the user data to all publishers prior to configuring and enabling user sync.</p> 
  <p>Once user sync is enabled, only newly created users and groups are 
   <g class="gr_ gr_10 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" data-gr-id="10" id="10">
    syncrhonized
   </g>.</p> 
  <p>2) Ensure the latest code has been installed :</p> 
  <ul> 
   <li><a href="https://helpx.adobe.com/experience-manager/kb/aem62-available-hotfixes.html">AEM platform updates</a></li> 
   <li><a href="../../../communities/using/deploy-communities.md#latestfeaturepack">AEM Communities updates</a></li> 
  </ul> 
  <h3>1. Apache Sling Distribution Agent - Sync Agents Factory</h3>
  <p><strong>Enable user sync</strong></p> 
  <ul> 
   <li><strong>on author</strong>
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4502/system/console/configMgr">http://localhost:4502/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">Apache Sling Distribution Agent - Sync Agents Factory</span>
      <ul> 
       <li>select the existing configuration to open for edit (pencil icon)<br /> Verify <span class="code">
         <g class="gr_ gr_14 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" data-gr-id="14" id="14">
          name
         </g></span>
        <g class="gr_ gr_14 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" data-gr-id="14" id="14">
          :
        </g> <strong><span class="code">
          <g class="gr_ gr_13 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling" data-gr-id="13" id="13">
           socialpubsync
          </g></span></strong></li> 
       <li>select the <span class="code">Enabled</span> checkbox</li> 
       <li>select <span class="code">Save</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <p><strong> </strong></p> 
  <img imageRotate="0" src="assets/chlimage_1-168.png" />
  <h3 id="createAuthuser">2. Create Authorized User</h3>
  <p><strong>Configure permissions</strong><br /> This authorized user will be used in step 3 to configure Sling distribution on author.</p> 
  <ul> 
   <li><strong>on each publish instance</strong>
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/administering/using/security.md">Security Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4503/useradmin">http://localhost:4503/useradmin</a></li> 
      </ul> </li> 
     <li>create a new user
      <ul> 
       <li>for example, <span class="code">usersync-admin</span></li> 
      </ul> </li> 
     <li>add this user to the <strong><span class="code">administrators</span></strong> user group</li> 
     <li><a href="#howtoaddacl">add ACL for this user to /home</a> 
      <ul> 
       <li><span class="code">Allow jcr:all</span> with restriction <span class="code">rep:glob=*/activities/*</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <note>
   <p>A new user must be created.</p> 
   <ul> 
    <li>The default user assigned is <strong><span class="code">admin</span></strong>.</li> 
    <li>Do not use <span class="code"><i>communities-user-admin </i>user<i>.</i></span></li> 
   </ul> 
  </note>
  <h4 id="AddACLs">How to Add ACL</h4>
  <ul> 
   <li>access CRXDE Lite
    <ul> 
     <li>for example, <a href="http://localhost:4503/crx/de">http://localhost:4503/crx/de</a></li> 
    </ul> </li> 
   <li>select<span class="code"> /home</span> node</li> 
   <li>in right pane, select the <span class="code">Access Control</span> tab</li> 
   <li>select the <span class="code">+</span> button to add an ACL entry
    <ul> 
     <li><strong>Principal</strong>: <i>search for user created for user sync</i></li> 
     <li><strong>Type</strong>: <span class="code">Allow</span></li> 
     <li><strong>Privileges</strong>: <span class="code">jcr:all</span></li> 
     <li><strong>Restrictions</strong> rep:glob: <span class="code">*/activities/*</span></li> 
     <li>select <strong>OK</strong></li> 
    </ul> </li> 
   <li>select <strong>Save All</strong></li> 
   <p> </p> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-169.png" />
  <p>See also</p> 
  <ul> 
   <li><a href="../../../sites/administering/using/user-group-ac-admin.md#accessrightmanagement">Access Right Management</a></li> 
   <li>Troubleshooting section <a href="#modifyoperationexceptionduringresponseprocessing">Modify Operation Exception During Response Processing</a>.</li> 
  </ul> 
  <h3 id="AdobeGraniteEncPasswrd">3. Adobe Granite Distribution - Encrypted Password Transport Secret Provider</h3>
  <p><strong>Configure permissions</strong></p> 
  <p>Once an authorized user, a member of the <strong><span class="code">administrators </span></strong>user group, has been created on all publish instances, that authorized user must be identified on author as having permission to sync user data from author to publish. </p> 
  <ul> 
   <li><strong>on author</strong>
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4502/system/console/configMgr">http://localhost:4502/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">Adobe Granite Distribution - Encrypted Password Transport Secret Provider</span></li> 
     <li>select the existing configuration to open for edit (pencil icon)<br /> Verify <span class="code">property name</span> : <strong><span class="code">socialpubsync-publishUser</span></strong></li> 
     <li>set the username and password to the <a href="#createauthorizeduser">authorized user</a> created on publish in step 2
      <ul> 
       <li>for example, <span class="code">usersync-admin</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-170.png" />
  <h3>4. Apache Sling Distribution Agent - Queue Agents Factory</h3>
  <p><strong>Enable user sync</strong></p> 
  <ul> 
   <li><strong>on publish</strong> :
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4503/system/console/configMgr">http://localhost:4503/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">Apache Sling Distribution Agent - Queue Agents Factory</span>
      <ul> 
       <li>select the existing configuration to open for edit (pencil icon)<br /> Verify <span class="code">Name</span> : <span class="code">socialpubsync-reverse</span></li> 
       <li>select the <span class="code">Enabled</span> checkbox</li> 
       <li>select <span class="code">Save</span></li> 
      </ul> </li> 
     <li><strong>repeat </strong>for each publish instance</li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-171.png" />
  <h3 id="DiffObserver">5. Adobe Granite Distribution - Diff Observer Factory</h3>
  <p><strong>Enable group sync</strong></p> 
  <ul> 
   <li><strong>on each publish instance</strong> :
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4503/system/console/configMgr">http://localhost:4503/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">Adobe Granite Distribution - Diff Observer Factory</span>
      <ul> 
       <li>select the existing configuration to open for edit (pencil icon)<br /> Verify <span class="code">agent name</span> : <span class="code">socialpubsync-reverse</span></li> 
       <li>select the <span class="code">Enabled</span> checkbox</li> 
       <li>select <span class="code">Save</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-172.png" />
  <h3>6. Apache Sling Distribution Trigger - Scheduled Triggers Factory</h3>
  <p><strong>(Optional) modify polling interval</strong></p> 
  <p>By default, author will poll for changes every 30 seconds. To alter this interval :</p> 
  <ul style="font-family: tahoma, arial, helvetica, sans-serif; font-size: 12px;"> 
   <li><strong>on author</strong>
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4502/system/console/configMgr">http://localhost:4502/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">Apache Sling Distribution Trigger - Scheduled Triggers Factory</span>
      <ul> 
       <li>select the existing configuration to open for edit (pencil icon)
        <ul> 
         <li>Verify <span class="code">Name</span> : <span class="code">socialpubsync-scheduled-trigger</span></li> 
        </ul> </li> 
       <li>set the <span class="code">Interval in Seconds</span> to the desired interval</li> 
       <li>select <span class="code">Save</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-173.png" />
  <h2>Configure for Multiple Publish Instances</h2>
  <draft-comment color="yellow" lastModifiedBy="ims-author-D9FB647253FD17BE0A4C98A6@AdobeID" lastModifiedDate="2018-01-12T05:19:08.155-0500" prevFirstName="unknown" prevLastName="unknown" type="remark">
   <p> <strong> ************ IMPORTANT - PLEASE READ **************</strong></p> 
   <p>All titles in this section are referenced from diagnostic code by GoURLs.</p> 
   <p><strong> navigate to : Tools, Operations, Diagnosis, User Sync Diagnostics</strong></p> 
   <p>If titles are altered, it may affect links to documentation embedded in code.</p> 
   <p><a href="https://jira.corp.adobe.com/browse/DOC-6923">DOC-6923 Health Checker for user sync</a></p> 
   <p><a href="https://wiki.corp.adobe.com/display/aemdoc/AEM+GoURLs">AEM GoURLs wiki</a> : look for URLs prefixed with <i>aem6_2_docs_usersync_multpub</i></p> 
  </draft-comment>
  <p>The default configuration is for a single publish instance. As the reason for enabling user sync is to synchronize multiple publish instances, such as for a publish farm, the additional publish instances will need to be added to the Sync Agents Factory.</p> 
  <h3>7. Apache Sling Distribution Agent - Sync Agents Factory</h3>
  <p><strong>Add Publish Instances :</strong></p> 
  <ul> 
   <li><strong>on author</strong>
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4502/system/console/configMgr">http://localhost:4502/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">Apache Sling Distribution Agent - Sync Agents Factory</span>
      <ul> 
       <li>select the existing configuration to open for edit (pencil icon)<br /> Verify <span class="code">Name</span> : <span class="code">socialpubsync</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-174.png" title="Default with Enabled not Checked" />
  <ul> 
   <li><strong>Exporter Endpoints</strong><br /> There should be an exporter endpoint for each publisher. For example, if there are 2 publishers, localhost:4503 and 4504, there should be 2 entries: 
    <ul> 
     <li>http://localhost:4503/libs/sling/distribution/services/exporters/socialpubsync-reverse</li> 
     <li>http://localhost:4504/libs/sling/distribution/services/exporters/socialpubsync-reverse</li> 
    </ul> </li> 
   <li><strong>Importer Endpoints</strong><br /> There should be an importer endpoint for each publisher. For example, if there are 2 publishers, localhost:4503 and 4504, there should be 2 entries:
    <ul> 
     <li>http://localhost:4503/libs/sling/distribution/services/importers/socialpubsync</li> 
     <li>http://localhost:4504/libs/sling/distribution/services/importers/socialpubsync </li> 
    </ul> </li> 
   <li>select <span class="code">Save</span></li> 
  </ul> 
  <h3>8. AEM Communities User Sync Listener</h3>
  <p><strong>(Optional) Sync additional JCR nodes</strong></p> 
  <p>If there is custom data that is desired to be synchronized across multiple publish instances, then :</p> 
  <ul> 
   <li><strong>on each publish instance</strong> :
    <ul> 
     <li>sign in with administrator privileges</li> 
     <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
      <ul> 
       <li>for example, <a href="http://localhost:4503/system/console/configMgr">http://localhost:4503/system/console/configMgr</a></li> 
      </ul> </li> 
     <li>locate <span class="code">AEM Communities User Sync Listener</span></li> 
     <li>select the existing configuration to open for edit (pencil icon)<br /> Verify <span class="code">
       <g class="gr_ gr_14 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" data-gr-id="14" id="14">
        Name
       </g></span>
      <g class="gr_ gr_14 gr-alert gr_gramm gr_inline_cards gr_disable_anim_appear Style multiReplace" data-gr-id="14" id="14">
        :
      </g> <span class="code">
       <g class="gr_ gr_13 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling" data-gr-id="13" id="13">
        socialpubsync
       </g>-scheduled-trigger</span></li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-175.png" />
  <ul> 
   <li><strong>Node Types</strong><br /> This is the list of node types that will synchronize. Any node type other than sling:Folder needs to be listed here (sling:folder is handled separately).<br /> Default list of node types to synchronize :
    <ul> 
     <li>rep:User</li> 
     <li>nt:unstructured</li> 
     <li>nt:resource</li> 
    </ul> </li> 
   <li><strong>Ignorable Properties</strong><br /> This is the list of properties that will be ignored if any change is detected. Changes to these properties might get synchronized as a side effect of other changes (since synchronization is always at the node level), but changes to these properties will not by themselves trigger synchronization.<br /> Default property to ignore :
    <ul> 
     <li>cq:lastModified</li> 
    </ul> </li> 
   <li><strong>Ignorable Nodes</strong><br /> Subpaths that will be entirely ignored during synchronization. Nothing under these subpaths will be synchronized at any time.<br /> Default nodes to ignore :
    <ul> 
     <li>.tokens</li> 
     <li>system</li> 
    </ul> </li> 
   <li><strong>Distributed Folders</strong><br /> Most sling:Folders are ignored because synchronization is not necessary. The few exceptions are listed here.<br /> Default folders to synchronize
    <ul> 
     <li>segments/scoring</li> 
     <li>social/relationships</li> 
     <li>activities</li> 
    </ul> </li> 
  </ul> 
  <h3>9. Unique Sling ID</h3>
  <note>
   <p> If the Sling ID matches between two or more publish instances then user group sync will fail.</p> 
  </note>
  <p>If the Sling ID is the same for multiple publish instances in a publish farm, then user groups will not be synchronized.</p> 
  <p>To validate that all Sling ID values differ, on each publish instance :</p> 
  <ol> 
   <li>browse to <a href="http://localhost:4503/system/console/status-slingsettings">http://<em>host:port</em>/system/console/status-slingsettings</a></li> 
   <li>check the value of <strong>Sling ID</strong></li> 
  </ol> 
  <img imageRotate="0" src="assets/chlimage_1-176.png" />
  <p>If the Sling ID of a publish instance matches the Sling ID of any other publish instance, then :</p> 
  <ol> 
   <li>stop one of the publish instances that has a matching Sling ID</li> 
   <li>in the 
    <g class="gr_ gr_15 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" data-gr-id="15" id="15">
     crx
    </g>-quickstart/launchpad/
    <g class="gr_ gr_14 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling ins-del multiReplace" data-gr-id="14" id="14">
     felix
    </g> directory
    <ul> 
     <li>search for and delete the file named <em>sling.id.file</em>
      <ul> 
       <li>for example, on a Linux system:<br /> <span class="code">rm -i $(find . -type f -name sling.id.file)</span></li> 
       <li>for example, on a Windows system:<br /> <span class="code">use windows explorer and search for <em>sling.id.file</em></span></li> 
      </ul> </li> 
    </ul> </li> 
   <li>start the publish instance 
    <ul> 
     <li>on 
      <g class="gr_ gr_17 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep" data-gr-id="17" id="17">
       startup
      </g> it will be assigned a new Sling ID</li> 
    </ul> </li> 
   <li>validate that the <strong>Sling ID</strong> is now unique</li> 
  </ol> 
  <p>Repeat these steps until all publish instances have 
   <g class="gr_ gr_16 gr-alert gr_gramm gr_inline_cards gr_run_anim Grammar multiReplace" data-gr-id="16" id="16">
    an unique
   </g> Sling ID.</p> 
  <h2>Vault Package Builder Factory</h2>
  <p>In order for updates to sync properly, it is necessary to modify the vault package builder for user sync :</p> 
  <ul> 
   <li>on each AEM publish instance</li> 
   <li>access the <a href="../../../sites/deploying/using/configuring-osgi.md">Web Console</a>
    <ul> 
     <li>for example, <a href="http://localhost:4503/system/console/configMgr">http://localhost:4503/system/console/configMgr</a></li> 
    </ul> </li> 
   <li>locate the <span class="code">Apache Sling Distribution Packaging - Vault Package Builder Factor</span>
    <ul> 
     <li><span class="code">Builder name: 
       <g class="gr_ gr_17 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling" data-gr-id="17" id="17">
        socialpubsync
       </g>-
       <g class="gr_ gr_18 gr-alert gr_spell gr_inline_cards gr_run_anim ContextualSpelling" data-gr-id="18" id="18">
        vlt
       </g></span></li> 
    </ul> </li> 
   <li>select the edit icon</li> 
   <li>add two <span class="code">Package Filters</span> :
    <ul> 
     <li><span class="code">/home/users|-.*/.tokens</span></li> 
     <li><span class="code">/home/users|-.*/rep:cache</span></li> 
    </ul> </li> 
   <li>policy handling :
    <ul> 
     <li>to overwrite existing rep
      <g class="gr_ gr_19 gr-alert gr_gramm gr_inline_cards gr_run_anim Style replaceWithoutSep" data-gr-id="19" id="19">
       :policy
      </g> nodes with new ones, add a third Package Filter :
      <ul> 
       <li><span class="code">/home/users|+.*/rep:policy</span></li> 
      </ul> </li> 
     <li>to prevent policies from being distributed, set
      <ul> 
       <li><span class="code">Acl 
         <g class="gr_ gr_22 gr-alert gr_gramm gr_inline_cards gr_run_anim Style multiReplace" data-gr-id="22" id="22">
          Handling :
         </g></span> <span class="code">IGNORE</span></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <img imageRotate="0" src="assets/chlimage_1-177.png" />
  <h2>What Happens When ...</h2>
  <h3>User Self-Registers or Edits Profile on Publish</h3>
  <p>By design, users and profiles created in the publish environment (self-registration) do not appear in the author environment. </p> 
  <p>When the topology is a <a href="../../../sites/deploying/using/recommended-deploys.md#tarmkfarm">publish farm</a> and user sync has been correctly configured, the <i>user </i>and <i>user profile</i> is synchronized across the publish farm using Sling distribution.</p> 
  <h3>Users or User Groups are Created Using Security Console</h3>
  <p>By design, user data created in the publish environment does not appear in the author environment and vice versa.</p> 
  <p>When the <a href="../../../sites/administering/using/security.md">User Administration and Security</a> console is used to add new users in the publish environment, user sync will synchronize the new users and their group membership to other publish instances, if necessary. User sync will also synchronize user groups created through the security console.</p> 
  <h2>Troubleshooting</h2>
  <h3>How to Take User Sync Offline</h3>
  <p>To take user sync offine, in order to <a href="#howtoremoveapublisher">remove a publisher</a> or <a href="#manuallysyncingusersandusergroups">manually sync data</a>, the distribution queue must be empty and quiet.</p> 
  <p>To check the state of the distribution queue :</p> 
  <ul> 
   <li>on author :
    <ul> 
     <li>using <a href="../../../sites/developing/using/developing-with-crxde-lite.md">CRXDE Lite</a>
      <ul> 
       <li>look for entries in <span class="code">/var/sling/distribution/packages</span> 
        <ul> 
         <li>folder nodes named with the pattern <span class="code">distrpackage_*</span></li> 
        </ul> </li> 
      </ul> </li> 
     <li>using <a href="../../../sites/administering/using/package-manager.md">Package Manager</a>
      <ul> 
       <li>look for pending packages (not yet installed)
        <ul> 
         <li>named with the pattern <span class="code">socialpubsync-vlt*</span></li> 
         <li>created by <span class="code">communities-user-admin</span></li> 
        </ul> </li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <p>When the distribution queue is empty, disable user sync :</p> 
  <ul> 
   <li>on author
    <ul> 
     <li><i>uncheck </i>the <span class="code">Enabled</span> checkbox for <a href="#1apacheslingdistributionagentsyncagentsfactory">Apache Sling Distribution Agent - Sync Agents Factory</a></li> 
    </ul> </li> 
  </ul> 
  <p>Once tasks are completed, to re-enable user sync :</p> 
  <ul> 
   <li>on author
    <ul> 
     <li>check the <span class="code">Enabled</span> checkbox for <a href="#1apacheslingdistributionagentsyncagentsfactory">Apache Sling Distribution Agent - Sync Agents Factory</a></li> 
    </ul> </li> 
  </ul> 
  <h3>User Sync Diagnostics</h3>
  <p>User Sync Diagnostics is a tool that checks the configuration and attempts to identify any problems.</p> 
  <p>On author, simply navigate from the main console through <strong>Tools, Operations, Diagnosis, User Sync Diagnostics.</strong></p> 
  <p>Simply entering the User Sync Diagnostics console will display the results.</p> 
  <p>This is what is displayed when User Synchronization has not been enabled :</p> 
  <img imageRotate="0" src="assets/chlimage_1-178.png" />
  <h4>How To Run Diagnostics for Publishers</h4>
  <p>When the diagnoistic is run from the author environment, the pass/fail results will include an [INFO] section displaying the list of configured publish instances for confirmation.</p> 
  <p>Included in the list is an URL for each publish instance that will run the diagnostics for that instance. The url param <span class="code">syncUser</span> is appended to the diagnostics URL with its value set to the <i>authorized sync user</i> created in <a href="../../../sites/administering/using/sync.md#2createauthorizeduser">Step 2</a>. </p> 
  <p><strong>Note</strong> : before launching the URL, the <i>authorized sync user</i> must already be signed into that publish instance.</p> 
  <img imageRotate="0" src="assets/chlimage_1-179.png" />
  <h3>Configuration Improperly Added</h3>
  <p>When user sync fails to work, the most common problem is that additional configurations were <i>added</i>. Instead, the <i>existing </i>default configuration should have been <i>edited</i>.</p> 
  <p>Following are views of how the edited, default configurations should appear in the Web Console. If more than the one instance appears, the added configuration should be removed.</p> 
  <h4>(author) One Apache Sling Distribution Agent - Sync Agents Factory</h4>
  <img imageRotate="0" src="assets/chlimage_1-180.png" />
  <h4>(author) One Adobe Granite Distribution - Encrypted Password Transport Secret Provider</h4>
  <img imageRotate="0" src="assets/chlimage_1-181.png" />
  <h4>(publish) One Apache Sling Distribution Agent - Queue Agents Factory</h4>
  <img imageRotate="0" src="assets/chlimage_1-182.png" />
  <h4>(publish) One Adobe Granite Distribution - Diff Observer Factory</h4>
  <img imageRotate="0" src="assets/chlimage_1-183.png" />
  <h4>(author) One Apache Sling Distribution Trigger - Scheduled Triggers Factory</h4>
  <img imageRotate="0" src="assets/chlimage_1-184.png" />
  <h3>Modify Operation Exception During Response Processing</h3>
  <p>If the following is visible in the log :</p> 
  <p style="margin-left: 40px;"><span class="code">org.apache.sling.servlets.post.impl.operations.ModifyOperation Exception during response processing.</span></p> 
  <p style="margin-left: 40px;"><span class="code">java.lang.IllegalStateException: This tree does not exist</span></p> 
  <p>Then verify that the section <a href="/content/docs/en/aem/6-1/administer/security/security/sync#2. Create Authorized User">2. Create Authorized User</a> was properly followed.</p> 
  <p>This section describes creating an authorized user, who exists on all publish instances, and identifying them in the 'Secret Provider' OSGi config on author. By default, the user is <span class="code">admin</span>.</p> 
  <p>The authorized user should be made a member of the <strong><span class="code">administrators</span></strong> user group and permissions for that group should not be altered.</p> 
  <p>The authorized user should explicitly have the following privileges and restriction on all publish instances :</p> 
  <table border="1" cellpadding="4" cellspacing="1" width="50%"> 
   <tbody>
    <tr>
     <td style="text-align: left;"><strong>path</strong></td> 
     <td style="text-align: center;"><strong>jcr:all</strong></td> 
     <td style="text-align: center;"><strong>rep:glob</strong></td> 
    </tr>
    <tr>
     <td style="text-align: left;">/home</td> 
     <td style="text-align: center;">X</td> 
     <td style="text-align: center;">*/activities/*</td> 
    </tr>
    <tr>
     <td style="text-align: left;">/home/users</td> 
     <td style="text-align: center;">X</td> 
     <td style="text-align: center;">*/activities/*</td> 
    </tr>
    <tr>
     <td style="text-align: left;">/home/groups</td> 
     <td style="text-align: center;">X</td> 
     <td style="text-align: center;">*/activities/*</td> 
    </tr>
   </tbody>
  </table> 
  <p>As a member of the <span class="code">administrators</span> group, the authorized user should have the following privileges on all publish instances :</p> 
  <table border="1" cellpadding="4" cellspacing="1" width="50%"> 
   <tbody>
    <tr>
     <td style="text-align: left;"><strong>path</strong></td> 
     <td style="text-align: center;"><strong>jcr:all</strong></td> 
     <td style="text-align: center;"><strong>jcr:read</strong></td> 
     <td style="text-align: center;"><strong>rep:write</strong></td> 
    </tr>
    <tr>
     <td style="text-align: left;">/etc/packages/sling/distribution</td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;">X</td> 
    </tr>
    <tr>
     <td style="text-align: left;">/libs/sling/distribution</td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;">X</td> 
     <td style="text-align: center;"> </td> 
    </tr>
    <tr>
     <td style="text-align: left;">/var</td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;">X</td> 
    </tr>
    <tr>
     <td style="text-align: left;">/var/eventing</td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;">X</td> 
     <td style="text-align: center;">X</td> 
    </tr>
    <tr>
     <td style="text-align: left;">/var/sling/distribution</td> 
     <td style="text-align: center;"> </td> 
     <td style="text-align: center;">X</td> 
     <td style="text-align: center;">X</td> 
    </tr>
   </tbody>
  </table> 
  <h3>User Group Sync Failed</h3>
  <p>If the Sling ID matches between two or more publish instances then user group sync will fail.</p> 
  <p>See section <a href="#9uniqueslingid">9. Unique Sling ID</a></p> 
  <h3>Manually Syncing Users and User Groups</h3>
  <ul> 
   <li>on publisher on which users and user groups exist :
    <ul> 
     <li><a href="#howtotakeusersyncoffline">if enabled, disable user sync</a></li> 
     <li><a href="../../../sites/administering/using/package-manager.md#creatinganewpackage">create a package</a> of <span class="code">/home</span>
      <ul> 
       <li>when editing the package
        <ul> 
         <li>Filters tab : Add Filter : Root path: <span class="code">/home</span></li> 
         <li>Advanced tab : AC Handling : <span class="code">Overwrite</span></li> 
        </ul> </li> 
      </ul> </li> 
     <li><a href="../../../sites/administering/using/package-manager.md#downloadingpackagestoyourfilesystem">export the package</a></li> 
    </ul> </li> 
   <li>on other publish instances :
    <ul> 
     <li><a href="../../../sites/administering/using/package-manager.md#installingpackages">import the package</a></li> 
    </ul> </li> 
  </ul> 
  <p>To configure or enable user sync, go to step 1: <a href="#1apacheslingdistributionagentsyncagentsfactory">Apache Sling Distribution Agent - Sync Agents Factory</a></p> 
  <h3>When a Publisher Becomes Unavailable</h3>
  <p>When a publish instance becomes unavailable, it should not be removed if it will be back online in the future. Changes will queue up for the publisher, and once it is back online, the changes will be processed.</p> 
  <p>If the publish instance will never be back online, if it is offline permanently, then it must be removed because the queue buildup will result in noticeable disk space usage in the author environment.</p> 
  <p>When a publisher is down, the author log will have exceptions similar to :</p> 
  <p><br /> <code class="code">28.01.2016 15:57:48.475 ERROR
    <discoiqbr /> [pool-12-thread-34-org_apache_sling_distribution_queue_socialpubsync_endpoint1
    <discoiqbr /> (org/apache/sling/distribution/queue/socialpubsync/endpoint1)]
    <discoiqbr /> org.apache.sling.distribution.agent.impl.SimpleDistributionAgent [agent][socialpubsync] could not deliver package distrpackage_1454014575838_a2b45ec8-0400-42f3-bed8-ae09b66381cb
    <discoiqbr /> org.apache.sling.distribution.packaging.DistributionPackageImportException: failed in importing package ...</code></p> 
  <h3>How To Remove a Publisher</h3>
  <p>To remove a publisher from the <a href="#7apacheslingdistributionagentsyncagentsfactory">Apache Sling Distribution Agent - Sync Agents Factory</a>, the distribution queue must be empty and quiet.</p> 
  <ul> 
   <li>on author :
    <ul> 
     <li><a href="#howtotakeusersyncoffline">Take user sync offline</a></li> 
     <li>follow <a href="#7apacheslingdistributionagentsyncagentsfactory">step 7</a> to remove the publisher from both server lists :
      <ul> 
       <li><span class="code">Exporter Endpoints</span></li> 
       <li><span class="code">Importer Endpoints</span></li> 
      </ul> </li> 
     <li>re-enable user sync
      <ul> 
       <li>check the <span class="code">Enabled</span> checkbox for <a href="#1apacheslingdistributionagentsyncagentsfactory">Apache Sling Distribution Agent - Sync Agents Factory</a></li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
 </body>
</html>