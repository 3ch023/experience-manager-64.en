<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="Using the CRX2Oak Migration Tool" name="seoTitle" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="df5641a4-65e1-4fb9-9131-31ed4fe81aac" name="jcr:predecessors" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="arkadius" name="cq:lastModifiedBy" /> 
  <meta content="Using the CRX2Oak Migration Tool" name="jcr:title" /> 
  <meta content="audience:deploying" name="primaryAudienceTag" /> 
  <meta content="2017-10-12T21:46:00.000-0400" name="qaDate" /> 
  <meta content="2019-01-11T03:09:03.615-0500" name="cq:lastModified" /> 
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;topic_tags:upgrading;content_type:reference" name="cq:tags" /> 
  <meta content="2018-04-03T08:47:01.388-0400" name="lastPublishExternalDate" /> 
  <meta content="/content/docs/en/aem/6-3/deploy/upgrade/using-crx2oak" name="qaNotes" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="2017-12-01T19:05:38.411-0500" name="jcr:created" /> 
  <meta content="2017-10-31T16:17:29.936-0400" name="firstPublishExternalDate" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="arkadius" name="cq:lastReplicatedBy" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="User" name="contentOwner" /> 
  <meta content="Using the CRX2Oak Migration Tool" name="navTitle" /> 
  <meta content="2018-04-30T03:29:28.098-0400" name="locHandOffDate" /> 
  <meta content="2019-01-11T03:09:09.502-0500" name="cq:lastReplicated" /> 
  <meta content="2018-04-03T08:47:01.388-0400" name="topicBrowsingSortDate" /> 
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html" name="publishExternalURL" /> 
  <meta content="false" name="isReadyForLocalization" /> 
  <meta content="Learn how to use the CRX2Oak migration tool." name="seoDescription" /> 
  <meta content="2018-04-03T08:47:01.388-0400" name="publishExternalDate" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/deploying/morehelp/upgrading;/content/help/en/experience-manager/6-4/sites/deploying/morehelp/upgrading" name="moreHelpPaths" /> 
  <meta content="21960ace-ce61-4343-9a74-e9e4096ff837" name="jcr:uuid" /> 
  <meta content="Activate" name="cq:lastReplicationAction" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
 </head> 
 <body> 
  <h2>Introduction</h2> 
  <p>CRX2Oak is a tool designed to migrate data between different repositories.</p> 
  <p>It can be used to migrate data from older CQ versions based on Apache Jackrabbit 2 to Oak, and it can also be used to copy data between Oak repositories.</p> 
  <p>You can download the newest version of crx2oak from the public Adobe repository at this location:<br /> <a href="https://repo.adobe.com/nexus/content/groups/public/com/adobe/granite/crx2oak/">https://repo.adobe.com/nexus/content/groups/public/com/adobe/granite/crx2oak/</a></p> 
  <p>The list of changes and fixes for the newest version can be found in the <a href="../../../release-notes/crx2oak.md">CRX2Oak Release Notes</a>.</p> 
  <note> 
   <p>For more information on Apache Oak and key concepts of AEM persistance, see <a href="../../../sites/deploying/using/platform.md">Introduction to the AEM Platform</a>.</p> 
  </note> 
  <h2>Migration Use Cases</h2> 
  <p>The tool can be used for:</p> 
  <ul> 
   <li>Migrating from older CQ 5 versions to AEM 6</li> 
   <li>Copying data between multiple Oak repositories</li> 
   <li>Converting data between different Oak MicroKernel implementations.</li> 
  </ul> 
  <p>Support for migrating repositories using external Blob Stores (commonly known as Data Stores) is provided in different combinations. One possible migration path is from a CRX2 repository that is using an external <span class="code">FileDataStore</span> to an Oak repository using a <span class="code">S3DataStore</span>.</p> 
  <p>The below diagram illustrates all the possible migration combinations supported by CRX2Oak:<br /> </p> 
  <img imageRotate="0" src="assets/chlimage_1-172.png" /> 
  <h2>Features</h2> 
  <p>CRX2Oak is called during AEM upgrades in a fashion in which the user can specify a predefined migration profile that automates the reconfiguration of persistence modes. This is called the quickstart mode.</p> 
  <p>It can also be run separately in case it requires more customization. However, note that in this mode changes are made only to the repository and any additional reconfiguration of AEM needs to be performed manually. This is called the standalone mode.</p> 
  <p>Another thing to note is that with the default settings in standalone mode, only the Node Store will be migrated and the new repository will re-use the old binary storage.</p> 
  <h4>Automated Quickstart Mode</h4> 
  <p>Since AEM 6.3, CRX2Oak is able to handle user defined migration profiles that can be configured with all the migration options already available. This allows for both higher flexibility, and the ability to automate configuration of AEM, features that are not available if you are using the tool in standalone mode.</p> 
  <p>In order to switch CRX2Oak to quickstart mode you need to define the path to crx-quickstart folder in the AEM installation directory via this operating system environmental variable:</p> 
  <p><strong>For UNIX based systems and macOS:</strong></p> 
  <codeblock gutter="true" class="syntax shell">
    export&amp;nbsp;SLING_HOME="/path/to/crx-quickstart" 
  </codeblock> 
  <p><strong>For Windows:</strong></p> 
  <codeblock gutter="true" class="syntax shell">
    SET&amp;nbsp;"SLING_HOME=/path/to/crx-quickstart" 
  </codeblock> 
  <h4>Resume Support</h4> 
  <p>The migration can be interrupted at any time, with the possibility to resume it afterwards.</p> 
  <h4>Customizable Upgrade Logic</h4> 
  <p>Custom Java logic cand also be implemented using <span class="code">CommitHooks</span>. Custom <span class="code">RepositoryInitializer</span> classes can be implemented in order to initialize the repository with custom values.</p> 
  <h4>Support for Memory Mapped Operations</h4> 
  <p>CRX2Oak also supports memory mapped operations by default. Memory mapping greatly improves performance and should be used whenever possible.</p> 
  <note> 
   <p>Note however that memory mapped operations are not supported for Windows platforms. Therefore, it is recommended to add the <strong>--disable-mmap</strong> parameter when performing the migration on Windows.</p> 
  </note> 
  <h4>Selective Migration of Content</h4> 
  <p>By default, the tool migrates the whole repository under the <span class="code">"/"</span> path. However, you have complete control over which content should be migrated.</p> 
  <p>If there is any part of the content that is not required on the new instance, you can use the <span class="code">--exclude-path</span> parameter to exclude the content and optimize the upgrade procedure.</p> 
  <h4>Path Merging</h4> 
  <p>If data needs to be copied between two repositories and you have a content path that is different on both instances, you can define it in the <span class="code">--merge-path</span> parameter. Once you do, CRX2Oak will copy only the new nodes to the destination repository and will keep the old ones in place.</p> 
  <img imageRotate="0" src="assets/chlimage_1-173.png" /> 
  <h4>Version Support</h4> 
  <p>By default, AEM will create a version of each node or page that gets modified, and store it in the repository. The versions can be then used to restore the page to an earlier state.</p> 
  <p>However, these versions are never purged even if the original page is deleted. When dealing with repositories that have been in operation for a long time, the migration might need to process a lot of redundant data caused by orphaned versions.<br /> </p> 
  <p>A useful feature for these types of situations is the addition of the <span class="code">--copy-versions</span> parameter. It can be used to skip the version nodes during migration or copy of a repository. </p> 
  <p>You can also choose whether to copy orphaned versions by adding <span class="code">--copy-orphaned-versions=true</span>. </p> 
  <p>Both parameters also support a <span class="code">YYYY-MM-DD</span> date format, in case you want to copy versions no later than a specific date.</p> 
  <img imageRotate="0" src="assets/chlimage_1-174.png" /> 
  <h4>Open Source Version</h4> 
  <p>An open source version of CRX2Oak is available in the form of oak-upgrade. It supports all the features except for:</p> 
  <ul> 
   <li>CRX2 support</li> 
   <li>Migration profile support</li> 
   <li>Support for automated AEM reconfiguration</li> 
  </ul> 
  <p>See the <a href="https://jackrabbit.apache.org/oak/docs/migration.html">Apache Documentation</a> for more information.</p> 
  <h2>Parameters</h2> 
  <h4>Node Store Options</h4> 
  <ul> 
   <li><span class="code">--cache</span>: Cache size in MB (default is <span class="code">256</span>)</li> 
   <li><span class="code">--mmap</span>: Enable memory mapped file access for Segment Store</li> 
   <li><span class="code">--src-password:</span> Password for the source RDB database<br /> </li> 
   <li><span class="code">--src-user:</span> User for the source RDB<br /> </li> 
   <li><span class="code">--user</span>: User for the targed RDB<br /> </li> 
   <li><span class="code">--password</span>: Password for the target RDB.<br /> </li> 
  </ul> 
  <h4>Migration Options</h4> 
  <ul> 
   <li><span class="code">--early-shutdown</span>: Shuts down the source JCR2 repository after nodes are copied and before the commit hooks are applied</li> 
   <li><span class="code">--fail-on-error</span>: Forces a failure of the migration if the nodes cannot be read from the source repository.</li> 
   <li><span class="code">--ldap</span>: Migrates LDAP users from a CQ 5.x instance to an Oak based one. In order for this to work, the Identity Provider in the Oak configuration needs to be named ldap. For more information, see the <a href="../../../sites/administering/using/ldap-config.md">LDAP documentation</a>.</li> 
   <li><span class="code">--ldap-config:</span> Use this in conjunction with the <span class="code">--ldap</span> parameter for CQ 5.x repositories that used multiple LDAP servers for authentication. You can use it to point to the CQ 5.x <span class="code">ldap_login.conf</span> or <span class="code">jaas.conf</span> configuration files. The format is <span class="code">--ldapconfig=path/to/ldap_login.conf</span>. </li> 
  </ul> 
  <h4>Version Store Options</h4> 
  <ul> 
   <li><span class="code">--copy-orphaned-versions</span>: Skips copying orphaned versions. Parameters supported are: <span class="code">true</span>, <span class="code">false</span> and <span class="code">yyyy-mm-dd</span>. Defaults to <span class="code">true</span>.</li> 
   <li><span class="code">--copy-versions:</span> Copies the version storage. Parameters: <span class="code">true</span>, <span class="code">false</span>, <span class="code">yyyy-mm-dd</span>. Defaults to <span class="code">true</span>.</li> 
  </ul> 
  <h4>Path Options</h4> 
  <ul> 
   <li><span class="code">--include-paths:</span> Comma-separated list of paths to include during copy</li> 
   <li><span class="code">--merge-paths</span>: Comma-separated list of paths to merge during copy</li> 
   <li><span class="code">--exclude-paths:</span> Comma-separated list of paths to exclude during copy.</li> 
  </ul> 
  <h4>Source Blob Store Options</h4> 
  <ul> 
   <li><span class="code">--src-datastore:</span> The datastore directory to be used as a source <span class="code">FileDataStore</span></li> 
   <li><span class="code">--src-fileblobstore</span>: The datastore directory to be used as a source <span class="code">FileBlobStore</span></li> 
   <li><span class="code">--src-s3datastore</span>: The datastore directory to be used for the source <span class="code">S3DataStore</span><br /> </li> 
   <li><span class="code">--src-s3config</span>: The configuration file for the source <span class="code">S3DataStore</span>.</li> 
  </ul> 
  <h4>Destination BlobStore Options</h4> 
  <ul> 
   <li><span class="code">--datastore:</span> The datastore directory to be used as a target <span class="code">FileDataStore</span></li> 
   <li><span class="code">--fileblobstore:</span> The datastore directory to be used as a target <span class="code">FileBlobStore</span></li> 
   <li><span class="code">--s3datastore</span>: The datastore directory to be used for the target <span class="code">S3DataStore</span></li> 
   <li><span class="code">--s3config</span>: The configuration file for the target <span class="code">S3DataStore</span>.</li> 
  </ul> 
  <h4>Help Options</h4> 
  <ul> 
   <li><span class="code">-?, -h, --help:</span> Shows help information.</li> 
  </ul> 
  <h2>Debugging</h2> 
  <p>You can also enable debug information for the migration process in order to troubleshoot any issues that might appear during the process. You can do this differently depending on the mode you wish to run the tool in:<br /> </p> 
  <table border="1" cellpadding="1" cellspacing="0" width="100%"> 
   <tbody> 
    <tr> 
     <td><strong>CRX2Oak Mode</strong></td> 
     <td><strong>Action</strong></td> 
    </tr> 
    <tr> 
     <td>Quickstart mode</td> 
     <td>You can add the <strong>--log-level TRACE</strong> or <strong>--log-level DEBUG </strong>options to the command line when running CRX2Oak. In this mode logs are automatically redirected to the <strong>upgrade.log file</strong>.</td> 
    </tr> 
    <tr> 
     <td>Standalone mode</td> 
     <td><p>Add the <strong>--trace</strong> options to the CRX2Oak command line to show TRACE events on standard output (you need to redirect logs yourself using redirection character: '&gt;' or 'tee' command for later inspection).</p> </td> 
    </tr> 
   </tbody> 
  </table> 
  <h2>Other Considerations</h2> 
  <p>When migrating to a MongoDB replica set, make sure you set the <span class="code">WriteConcern</span> parameter to <span class="code">2</span> on all connections to the Mongo databases.</p> 
  <p>You can do this by adding the <span class="code">w=2</span> parameter at the end of the connection string, like this:<br /> </p> 
  <codeblock gutter="true" class="syntax xml">
    java&amp;nbsp;-Xmx4092m&amp;nbsp;-XX:MaxPermSize=1024m&amp;nbsp;-jar&amp;nbsp;crx2oak.jar&amp;nbsp;crx-quickstart/repository/&amp;nbsp;mongodb://localhost:27017/aem-author?replicaset=replica1&amp;w=2 
  </codeblock> 
  <note> 
   <p>For more information, see the MongoDB Connection String documentation on <a href="https://docs.mongodb.org/manual/reference/connection-string/#write-concern-options">Write Concerns</a>.</p> 
  </note> 
 </body> 
</html>