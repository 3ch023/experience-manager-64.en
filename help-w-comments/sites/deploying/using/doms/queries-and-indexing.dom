<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="alvawb" name="cq:lastModifiedBy" /> 
  <meta content="Oak Queries and Indexing" name="navTitle" /> 
  <meta content="2018-04-03T08:42:44.180-0400" name="publishExternalDate" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="2017-10-31T16:17:46.389-0400" name="firstPublishExternalDate" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="User" name="contentOwner" /> 
  <meta content="Activate" name="cq:lastReplicationAction" /> 
  <meta content="a77ec311-c91a-4897-84de-008c99b63d23" name="jcr:uuid" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;content_type:reference;topic_tags:deploying" name="cq:tags" /> 
  <meta content="2018-10-17T08:39:27.544-0400" name="cq:lastModified" /> 
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/queries-and-indexing.html" name="publishExternalURL" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="false" name="isReadyForLocalization" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/deploying/morehelp/deploying;/content/help/en/experience-manager/6-4/sites/deploying/morehelp/deploying" name="moreHelpPaths" /> 
  <meta content="2018-04-03T08:42:44.180-0400" name="topicBrowsingSortDate" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="locales:fr;locales:de;locales:ja" name="locLangTag" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
  <meta content="carlino@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="carlino" name="cq:lastReplicatedBy" /> 
  <meta content="2018-04-03T08:42:45.128-0400" name="cq:lastReplicated" /> 
  <meta content="2018-04-03T08:42:44.180-0400" name="lastPublishExternalDate" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" /> 
  <meta content="/content/docs/en/aem/6-3/deploy/platform/queries-and-indexing" name="qaNotes" /> 
  <meta content="2018-09-14T19:29:44.029-0400" name="locHandOffDate" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="Learn how to configure indexes in AEM." name="seoDescription" /> 
  <meta content="2017-10-12T21:46:00.000-0400" name="qaDate" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="2018-02-22T08:02:59.329-0500" name="jcr:created" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="audience:deploying" name="primaryAudienceTag" /> 
  <meta content="Oak Queries and Indexing" name="seoTitle" /> 
  <meta content="/content/docs/en/aem/6-0/deploy/upgrade/queries-and-indexing" name="legacyPath" /> 
  <meta content="ab9875d3-f401-4480-b84b-175e853d20a9" name="jcr:predecessors" /> 
  <meta content="Oak Queries and Indexing" name="jcr:title" /> 
 </head> 
 <body> 
  <note> 
   <p>This article is about configuring indexes in AEM 6. For best practices on optimizing query and indexing performance, see <a href="../../../sites/deploying/using/best-practices-for-queries-and-indexing.md">Best Practices for Queries and Indexing</a>.<br /> </p> 
  </note> 
  <h2>Introduction</h2> 
  <p>Unlike Jackrabbit 2, Oak does not index content by default. Custom indexes need to be created when necessary, much like with traditional relational databases. If there is no index for a specific query, possibly many nodes will be traversed. The query may still work but probably be very slow. </p> 
  <p>If Oak encounters a query without an index, a WARN level log message is printed:</p> 
  <codeblock gutter="true" class="syntax xml">
    *WARN*&amp;nbsp;Traversed&amp;nbsp;1000&amp;nbsp;nodes&amp;nbsp;with&amp;nbsp;filter&amp;nbsp;Filter(query=select&amp;nbsp;...)&amp;nbsp;consider&amp;nbsp;creating&amp;nbsp;an&amp;nbsp;index&amp;nbsp;or&amp;nbsp;changing&amp;nbsp;the&amp;nbsp;query 
  </codeblock> 
  <h2>Supported query languages</h2> 
  <p>The Oak query engine supports the following languages:</p> 
  <ul> 
   <li>XPath (recommended)</li> 
   <li>SQL-2</li> 
   <li>SQL (deprecated)</li> 
   <li>JQOM</li> 
  </ul> 
  <h2>Indexer types and cost calculation</h2> 
  <p>The Apache Oak based backend allows different indexers to be plugged into the repository.</p> 
  <p>One indexer is the <strong>Property Index</strong>, for which the index definition is stored in the repository itself.</p> 
  <p>Implementations for <strong>Apache Lucene</strong> and <strong>Solr </strong>are also available by default, which both support fulltext indexing.</p> 
  <p>The <strong>Traversal Index</strong> is used if no other indexer is available. This means that the content is not indexed and content nodes are traversed to find matches to the query.</p> 
  <p>If multiple indexers are available for a query, each available indexer estimates the cost of executing the query. Oak then chooses the indexer with the lowest estimated cost.</p> 
  <img imageRotate="0" src="assets/chlimage_1-166.png" /> 
  <p>The above diagram is a high level representation of the query execution mechanism of Apache Oak.</p> 
  <p>First, the query is parsed into an Abstract Syntax Tree. Then, the query is checked and transformed into SQL-2 which is the native language for Oak queries.</p> 
  <p>Next, each index is consulted to estimate the cost for the query. Once that is completed, the results from the cheapest index are retrieved. Finally, the results are filtered, both to ensure that the current user has read access to the result and that the result matches the complete query.</p> 
  <h2>Configuring the indexes</h2> 
  <note /> 
  <p>Note: For a large repository, building an index is a time consuming operation. This is true for both the initial creation of an index, and reindexing (rebuilding an index after changing the definition). See also "Troubleshooting Oak Indexes" section "Preventing slow re-indexing".</p> 
  <p>If reindexing is needed in very large repositories, specially when using MongoDB and for fulltext indexes, consider text pre-extraction, and using oak-run to build the initial index and to reindex.<br /> </p> 
  <p>Indexes are configured as nodes in the repository under the <strong>oak:index</strong> node. </p> 
  <p>The type of the index node must be <strong>oak:QueryIndexDefinition.</strong> Several configuration options are available for each indexer as node properties. For more information, see the configuration details for each indexer type below.</p> 
  <h3>The Property Index</h3> 
  <p>The Property Index is generally useful for queries that have property constraints but are not full-text. It can be configured by following the below procedure:<br /> </p> 
  <ol> 
   <li><p>Open CRXDE by going to <span class="code">http://localhost:4502/crx/de/index.jsp</span></p> </li> 
   <li><p>Create a new node under <strong>oak:index</strong></p> </li> 
   <li><p>Name the node <strong>PropertyIndex</strong>, and set the node type to <strong>oak:QueryIndexDefinition</strong></p> </li> 
   <li><p>Set the following properties for the new node:</p> 
    <ul> 
     <li><strong>type: </strong><span class="code">property</span> (of type String)<br /> </li> 
     <li><strong>propertyNames: </strong><span class="code">jcr:uuid</span> (of type Name)</li> 
    </ul> <p>This particular example will index the <span class="code">jcr:uuid</span> property, whose job is to expose the universally unique idetifier (UUID) of the node it is attached to.</p> </li> 
   <li><p>Save the changes.</p> </li> 
  </ol> 
  <p>The Property Index has the following configuration options:</p> 
  <ul> 
   <li>The <strong>type</strong> property<strong> </strong>will specify the type of index, and in this case it must be set to <strong>property</strong></li> 
   <li>The <strong>propertyNames</strong> property indicates the list of the properties that will be stored in the index. In case it is missing, the node name will be used as a property name reference value. In this example, the <strong>jcr:uuid</strong> property whose job is to expose the unique identifier (UUID) of its node is added to the index.</li> 
   <li>The<strong> unique</strong> flag which, if set to <strong>true </strong>adds a uniqueness constraint on the property index.<br /> </li> 
   <li>The <strong>declaringNodeTypes</strong> propery allows you to specify a certain node type that the index will only apply to.</li> 
   <li>The <strong>reindex</strong> flag which if set to <strong>true</strong>, will trigger a full content reindex.</li> 
  </ul> 
  <h3>The Ordered Index</h3> 
  <p>The Ordered index is an extension of the Property index. However, it has been deprecated. Indexes of this type need to be replaced with the Lucene Property index (see below).</p> 
  <h3>The Lucene Full Text Index</h3> 
  <p>A full text indexer based on Apache Lucene is available in AEM 6.<br /> </p> 
  <p>If a full-text index is configured, then all queries that have a full-text condition use the full-text index, no matter if there are other conditions that are indexed, and no matter if there is a path restriction.</p> 
  <p>If no full-text index is configured, then queries with full-text conditions will not work as expected.</p> 
  <p>Because the index is updated via an asynchronbous background thread, some full-text searches will be unavailable for a small window of time until the background processes are finished.</p> 
  <p>You can configure a Lucene full-text index, by following the below procedure:</p> 
  <ol> 
   <li><p>Open CRXDE and create a new node under <strong>oak:index</strong>.</p> </li> 
   <li><p>Name the node <strong>LuceneIndex</strong> and set the node type to <strong>oak:QueryIndexDefinition</strong></p> </li> 
   <li><p>Add the following properties to the node:</p> 
    <ul> 
     <li><strong>type: </strong><span class="code">lucene</span> (of type String)<br /> </li> 
     <li><strong>async: </strong><span class="code">async</span> (of type String)<br /> </li> 
    </ul>  </li> 
   <li><p>Save the changes.</p> </li> 
  </ol> 
  <p>The Lucene Index has the following configuration options:</p> 
  <ul> 
   <li>The <strong>type</strong> property which will specify the type of index must be set to <strong>lucene</strong></li> 
   <li>The <strong>async</strong> property which must be set to <strong>async</strong>. This will send the index update process to a background thread.</li> 
   <li>The <strong>includePropertyTypes</strong> property, which will define what subset of property types will be included in the index.</li> 
   <li>The <strong>excludePropertyNames</strong> property which will define a blacklist of property names - properties that should be excluded from the index.</li> 
   <li>The <strong>reindex</strong> flag which when set to <strong>true</strong>, triggers a full content re-index.</li> 
  </ul> 
  <h3>The Lucene Property Index</h3> 
  <p>Since <strong>Oak 1.0.8</strong>, Lucene can be used to create indexes which involve property constraints that are not full-text.</p> 
  <p>In order to achieve a Lucene Property Index the <strong>fulltextEnabled</strong> property must always be set to false.</p> 
  <p>Take the following example query:<br /> </p> 
  <p> </p> 
  <codeblock class="syntax xml">
    select&amp;nbsp;*&amp;nbsp;from&amp;nbsp;[nt:base]&amp;nbsp;where&amp;nbsp;[alias]&amp;nbsp;=&amp;nbsp;'/admin' 
  </codeblock> 
  <p>In order to define a Lucene Property Index for the above query, you can add the following definition by creating a new node under <strong>oak:index:</strong></p> 
  <ul> 
   <li><strong>Name:</strong> <span class="code">LucenePropertyIndex</span></li> 
   <li><strong>Type:</strong> <span class="code">oak:QueryIndexDefinition</span></li> 
  </ul> 
  <p>Once the node has been created, add the following properties:</p> 
  <ul> 
   <li><strong>type:</strong> <code class="code">lucene (of type String)
     <discoiqbr /> </code></li> 
   <li><strong>async:</strong> <code class="code">async (of type String)
     <discoiqbr /> </code></li> 
   <li><strong>fulltextEnabled:</strong> <code class="code">false (of type Boolean)
     <discoiqbr /> </code></li> 
   <li><strong>includePropertyNames:</strong> <span class="code">["alias"] (of type String)</span></li> 
  </ul> 
  <p> </p> 
  <note> 
   <p>Compared to the regular Property Index, the Lucene Property Index is always configured in async mode. Thus, the results returned by index may not always reflect the most up to date state of the repository.<br /> </p> 
  </note> 
  <note> 
   <p>For more specific information on the Lucene Property Index, see the <a href="http://jackrabbit.apache.org/oak/docs/query/lucene.html">Apache Jackrabbit Oak Lucene documentation page</a>.<br /> </p> 
  </note> 
  <h3>Lucene Analyzers</h3> 
  <p>Since version 1.2.0, Oak supports Lucene analyzers.</p> 
  <p>Analyzers are used both when a document is indexed, and at query time. An analyzer examines the text of fields and generates a token stream. Lucene analyzers are composed of a series of tokenizer and filter classes.</p> 
  <p>The analyzers can be configured via the <span class="code">analyzers</span> node (of type <span class="code">nt:unstructured</span>) inside the <span class="code">oak:index</span> definition.</p> 
  <p>The default analyzer for an index is configured in the <span class="code">default</span> child of the analyzers node.<br /> </p> 
  <img imageRotate="0" src="assets/chlimage_1-167.png" /> 
  <note> 
   <p>For a list of available analyzers, please consult the API documentation of the Lucene version you are using.</p> 
  </note> 
  <h4>Specifying the Analyzer Class Directly</h4> 
  <p>If you wish to use any out of the box analyzer, you can configure it following the below procedure:</p> 
  <ol> 
   <li><p>Locate the index you wish to use the analyzer with under the <span class="code">oak:index</span> node.<br /> </p> </li> 
   <li><p>Under the index, create a child node called <span class="code">default</span> of type <span class="code">nt:unstructured</span>.<br /> </p> </li> 
   <li><p>Add a property to the default node with the following properties:</p> 
    <ul> 
     <li><strong>Name:</strong> <span class="code">class</span></li> 
     <li><strong>Type:</strong> <span class="code">String</span></li> 
     <li><strong>Value:</strong> <span class="code">org.apache.lucene.analysis.standard.StandardAnalyzer</span></li> 
    </ul> <p>The value is the name of the analyzer class you wish to use.</p> <p>You can also set the analyzer to be used with a specific lucene version by using the optional <span class="code">luceneMatchVersion</span> string propery. A valid synthax for using it with Lucene 4.7 would be:</p> 
    <ul> 
     <li><strong>Name:</strong> <span class="code">luceneMatchVersion</span></li> 
     <li><strong>Type:</strong> <span class="code">String</span></li> 
     <li><strong>Value:</strong> <span class="code">LUCENE_47</span></li> 
    </ul> <p>If <span class="code">luceneMatchVersion</span> is not provided, Oak will use the version of Lucene it is shipped with.<br /> </p> </li> 
   <li><p>If you wish to add a stopwords file to the analyzer configurations, you can create a new node under the <span class="code">default</span> one with the following properties:</p> 
    <ul> 
     <li><strong>Name:</strong> <span class="code">stopwords</span></li> 
     <li><strong>Type:</strong> <span class="code">nt:file</span></li> 
    </ul> </li> 
  </ol> 
  <h4>Creating Analyzers via Composition</h4> 
  <p>Analyzers can also be composed based on <span class="code">Tokenizers</span>, <span class="code">TokenFilters</span> and <span class="code">CharFilters</span>. You can do this by specifying an analyzer and creating children nodes of its optional tokenizers and filters which will be applied in listed order.<a href="https://wiki.apache.org/solr/AnalyzersTokenizersTokenFilters#Specifying_an_Analyzer_in_the_schema"></a></p> 
  <p>Consider this node structure as an example:</p> 
  <ul> 
   <li><strong>Name:</strong> <span class="code">analyzers</span> 
    <ul> 
     <li><strong>Name:</strong> <span class="code">default</span> 
      <ul> 
       <li><strong>Name:</strong> <span class="code">charFilters</span></li> 
       <li><strong>Type:</strong> <span class="code">nt:unstructured</span> 
        <ul> 
         <li><strong>Name:</strong> <span class="code">HTMLStrip</span></li> 
         <li><strong>Name:</strong> <span class="code">Mapping</span></li> 
        </ul> </li> 
       <li><strong>Name:</strong> <span class="code">tokenizer</span> 
        <ul> 
         <li><strong>Property Name:</strong> <span class="code">name</span> 
          <ul> 
           <li><strong>Type:</strong> <span class="code">String</span></li> 
           <li><strong>Value:</strong> <span class="code">Standard</span></li> 
          </ul> </li> 
        </ul> </li> 
       <li><strong>Name:</strong> <span class="code">filters</span></li> 
       <li><strong>Type:</strong> <span class="code">nt:unstructured</span> 
        <ul> 
         <li><strong>Name:</strong> <span class="code">LowerCase</span></li> 
         <li><strong>Name:</strong> <span class="code">Stop</span> 
          <ul> 
           <li><strong>Property name:</strong> <span class="code">words</span> 
            <ul> 
             <li><strong>Type:</strong> <span class="code">String</span></li> 
             <li><strong>Value:</strong> <span class="code">stop1.txt, stop2.txt</span></li> 
            </ul> </li> 
           <li><strong>Name:</strong> <span class="code">stop1.txt</span> 
            <ul> 
             <li><strong>Type:</strong> <span class="code">nt:file</span></li> 
            </ul> </li> 
           <li><strong>Name:</strong> <span class="code">stop2.txt</span> 
            <ul> 
             <li><strong>Type:</strong> <span class="code">nt:file</span></li> 
            </ul> </li> 
          </ul> </li> 
        </ul> </li> 
      </ul> </li> 
    </ul> </li> 
  </ul> 
  <p>The name of the filters, charFilters and tokenizers are formed by removing the factory suffixes. Thus:</p> 
  <ul> 
   <li><span class="code">org.apache.lucene.analysis.standard.StandardTokenizerFactory</span> becomes <span class="code">standard</span></li> 
   <li><span class="code">org.apache.lucene.analysis.charfilter.MappingCharFilterFactory</span> becomes <span class="code">Mapping</span></li> 
   <li><span class="code">org.apache.lucene.analysis.core.StopFilterFactory</span> becomes <span class="code">Stop</span></li> 
  </ul> 
  <p> </p> 
  <p>Any configuration parameter required for the factory is specified as property of the the node in question. </p> 
  <p>For cases such as loading stop words where content from external files needs to be loaded, the content can be provided by creating a child node of <span class="code">nt:file</span> type for the file in question.<br /> </p> 
  <h3>The Solr Index</h3> 
  <p>The purpose of the Solr index is mainly full-text search but it can also be used to index search by path, property restrictions and primary type restrictions. This means the Solr index in Oak can be used for any type of JCR query.</p> 
  <p>The integration in AEM happens at the repository level so that Solr is one of the possible indexes that can be used in Oak, the new repository implementation shipped with AEM.</p> 
  <p>It can be configured to work as an embedded server with the AEM instance, or as a remote server.</p> 
  <h3>Configuring AEM with an embedded Solr server</h3> 
  <note> 
   <p>Do not use an embedded Solr server in a production enviroment. It should be used only in a development enviroment.</p> 
  </note> 
  <p>AEM can be used with an embedded Solr server that can be configured via the Web Console. In this case, the Solr server will run in the same JVM as the AEM instance it is embedded to.</p> 
  <p>You can configure the embedded Solr server by:</p> 
  <ol> 
   <li><p>Going to the Web Console at <span class="code">http://serveraddress:4502/system/console/configMgr</span></p> </li> 
   <li><p>Search for "<strong>Oak Solr server provider</strong>".</p> </li> 
   <li><p>Press the edit button and in the following window set the server type to <strong>Embedded Solr</strong> in the drop-down list.<br /> </p> </li> 
   <li><p>Next, edit "<strong>Oak Solr embedded server configuration</strong>" and create a configuration. For more info on the configuration options, please visit the <a href="http://lucene.apache.org/solr/documentation.html">Apache Solr website</a>.<br /> </p> 
    <note> 
     <p>The Solr home directory (solr.home.path) configuration will look for a folder with the same name in the AEM installation folder.</p> 
    </note></li> 
   <li><p>Open CRXDE and login as Admin.</p> </li> 
   <li><p>Add a node called <strong>solrlndex</strong> of type <strong>oak:QueryIndexDefinition </strong>under <strong>oak:index</strong> with the following properties:</p> 
    <ul> 
     <li><strong>type:</strong><span class="code">solr </span>(of type String)</li> 
     <li><strong>async:</strong><span class="code">async </span>(of type String)</li> 
     <li><strong>reindex:</strong><span class="code">true </span>(of type Boolean)</li> 
    </ul> </li> 
   <li><p>Save the changes.</p> </li> 
  </ol> 
  <h3>Configuring AEM with a single remote Solr server</h3> 
  <p>AEM can also be confiured to work with a remote Solr server instance:</p> 
  <ol> 
   <li><p>Download and extract the latest version of Solr. For more info on how to do this, please consult the <a href="https://cwiki.apache.org/confluence/display/solr/Installing+Solr">Apache Solr Installation documentation</a>.</p> </li> 
   <li><p>Now, create two Solr shards. You can do this by creating folders for each shard in the folder where Solr has been upacked:</p> 
    <ul> 
     <li>For the first shard, create the folder:<span class="code"></span></li> 
    </ul>  
    <ul> 
     <li>For the second shard, create the folder:<span class="code"></span></li> 
    </ul>  </li> 
   <li><p>Locate the example instance in the Solr package. It is usually located in a folder called "<span class="code">example</span>" in the root of the package.</p> </li> 
   <li><p>Copy the following folders from the example instance to the two shard folders (<span class="code">aemsolr1\node1</span> and <span class="code">aemsolr2\node2</span>):</p> 
    <ul> 
     <li><span class="code">contexts</span></li> 
     <li><span class="code">etc</span></li> 
     <li><span class="code">lib</span></li> 
     <li><span class="code">resources</span></li> 
     <li><span class="code">scripts</span></li> 
     <li><span class="code">solr-webapp</span></li> 
     <li><span class="code">webapps</span></li> 
     <li><span class="code">start.jar</span></li> 
    </ul>  </li> 
   <li><p>Create a new folder called "<span class="code">cfg</span>" in each of the two shard folders.</p> </li> 
   <li><p>Place your Solr and Zookeeper configuration files in the newly created <span class="code">cfg</span> folders.<br /> </p> 
    <note> 
     <p>For more info on Solr and ZooKeeper configuration, consult the <a href="https://wiki.apache.org/solr/ConfiguringSolr">Solr Configuration documentation</a> and the <a href="http://zookeeper.apache.org/doc/r3.1.2/zookeeperStarted.html">ZooKeeper Getting Started Guide</a>.</p> 
    </note></li> 
   <li><p>Start the first shard with ZooKeeper support by going to <span class="code">aemsolr1\node1</span> and running the following command:</p> 
    <codeblock class="syntax xml">
      java&amp;nbsp;-Xmx2g&amp;nbsp;-Dbootstrap_confdir=./cfg/oak/conf&amp;nbsp;-Dcollection.configName=myconf&amp;nbsp;-DzkRun&amp;nbsp;-DnumShards=2&amp;nbsp;-jar&amp;nbsp;start.jar 
    </codeblock></li> 
   <li><p>Start the second shard by going to <span class="code">aemsolr2\node2</span> and running the following command:</p> 
    <codeblock class="syntax xml">
      java&amp;nbsp;-Xmx2g&amp;nbsp;-Djetty.port=7574&amp;nbsp;-DzkHost=localhost:9983&amp;nbsp;-jar&amp;nbsp;start.jar 
    </codeblock></li> 
   <li><p>After both shards have been started, test that everything is up and running by connecting to the Solr interface at <span class="code">http://localhost:8983/solr/#/</span></p> </li> 
   <li><p>Start AEM and go to the Web Console at <span class="code">http://localhost:4502/system/console/configMgr</span></p> </li> 
   <li><p>Set the following configuration under <strong>Oak Solr remote server configuration</strong>:</p> 
    <ul> 
     <li>Solr HTTP URL: <span class="code">http://localhost:8983/solr/</span></li> 
    </ul> </li> 
   <li><p>Choose <strong>Remote Solr</strong> in the drop down list under <strong>Oak Solr</strong> server provider.<br /> </p> </li> 
   <li><p>Go to CRXDE and login as Admin.</p> </li> 
   <li><p>Create a new node called <strong>solrIndex</strong> under <strong>oak:index</strong>, and set the following properties:</p> 
    <ul> 
     <li><strong>type:</strong>solr (of type String)</li> 
     <li><strong>async:</strong>async (of type String)</li> 
     <li><strong>reindex:</strong>true (of type Boolean)<br /> </li> 
    </ul>  </li> 
   <li><p>Save the changes.</p> </li> 
  </ol> 
  <h4>Recommended configuration for Solr</h4> 
  <p>Below is an example of a base configuration that can be used with all three Solr deployments described in this article. It accomodates the dedicated property indexes that are already present in AEM and should not be used with other applications.</p> 
  <p>In order to properly use it, you need to place the contents of the archive directly in the Solr Home Directory. In the case of multi-node deployments, it should go directly under the root folder of each node.<br /> </p> 
  <div> 
   <p>Recommended Solr configuration files</p> 
   <p><a alt="recommended-conf.zip" href="assets/recommended-conf.zip">Get File</a></p> 
  </div> 
  <draft-comment color="yellow" lastModifiedBy="ims-author-AAC0465A528DC04F0A490D44@AdobeID" lastModifiedDate="2018-02-22T05:06:45.702-0500" prevFirstName="unknown" prevLastName="unknown" type="remark"> 
   <p>The ACS Indexing tools are a part of the product since 6.1, and will be moved to the Ops Dashboard page. See DOC-5152 and DOC-5138</p> 
  </draft-comment> 
  <h3>AEM Indexing Tools</h3> 
  <p>AEM 6.1 also integrates two indexing tools present in AEM 6.0 as part of the Adobe Consulting Services Commons toolset:<br /> </p> 
  <ol> 
   <li><strong>Explain Query</strong>, a tool designed to help administrators understand how queries are executed;</li> 
   <li><strong>Oak Index Manager</strong>, a Web User Interface for maintaining existing indexes.</li> 
  </ol> 
  <p>You can now reach them by going to <strong>Tools - Operations - Dashboard - Diagnosis</strong> from the AEM Welcome screen.</p> 
  <p>For more information on how to use them, see the <a href="../../../sites/administering/using/operations-dashboard.md">Operations Dashboard documentation</a>.</p> 
  <draft-comment type="draft"> 
   <h3>ACS Commons Indexing Tools</h3> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <p>The <a href="https://adobe-consulting-services.github.io/acs-aem-commons/">Adobe Consulting Service Commons</a> toolkit introduces a set of indexing tools in an effort to simplify management and maintenance of indexes in the underlining data storage layer of AEM, Apache OAK.</p> 
   <p>The tools are:</p> 
   <ul> 
    <li><strong>Explain Query</strong>, a tool designed to help administrators understand how queries are executed;<br /> </li> 
    <li><strong>Oak Index Manager</strong>, a Web User Interface for maintaining existing indexes.</li> 
   </ul> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <note type="note"> 
    <p>Starting with AEM 6.1, both the Explain Query and Oak Index Manager tools will ship with product, thus eliminating the need to install the separately.</p> 
    <p>You can reach them by going to <strong>Tools - Operations - Dashboard - Diagnosis</strong> from the AEM Welcome screen.<br /> </p> 
   </note> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <h4>The Explain Query Tool</h4> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <p>For any given query, Oak attempts to figure out the best way to execute based on the Oak indexes defined in the repository under the <strong>oak:index</strong> node. Depending on the query, different indexes may be chosen by Oak. Understanding how Oak is executing a query is the first step to optimizing the query.</p> 
   <p>The Explain Query is a tool that explains how Oak is executing a query.</p> 
   <p><strong>Features</strong></p> 
   <ul> 
    <li>Supports the Xpath, JCR-SQL and JCR-SQL2 query languages<br /> </li> 
    <li>Reports the actual execution time of the provided query<br /> </li> 
    <li>Detects slow queries and warns about queries that could be potentially slow<strong></strong><br /> </li> 
    <li>Reports the Oak index used to execute the query</li> 
    <li>Displays the actual Oak Query engine explanation</li> 
    <li>Provides click-to-load list of Slow and Popular queries</li> 
   </ul> 
   <p><strong>Installing Explain Query</strong></p> 
   <p>Explain Query is part of the ACS Toolset and can be installed as a standard AEM package. In order to use it, you need to:<br /> </p> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <ol> 
    <li><p>Go to the <a href="https://adobe-consulting-services.github.io/acs-aem-tools/">ACS Tools Website</a> and download the package.</p> </li> 
    <li><p>Go to <span class="code">http://localhost:4502/crx/packmgr/index.js</span>p to access the Package Manager.</p> </li> 
    <li><p>Upload the package and install it. For more information on how to work with Package Manager, see <a href="../../../sites/administering/using/package-manager.md#main-pars-title-10">How to Work with Packages</a>.</p> </li> 
    <li><p>Access the Explain Query UI by pointing your browser to <span class="code">http://localhost:4502/etc/acs-tools/explain-query.html</span><br /> </p> </li> 
   </ol> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <p>Once in the Explain Query UI, select the query language, enter a query and press the Explain button.</p> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <img imageRotate="0" src="assets/chlimage_1-168.png" /> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <p>The first entry in the Query Explanation section is the actual explanation. The explanation will show the type of index that was used to execute the query.</p> 
   <p>The second entry is the query plan.</p> 
   <p>Ticking the <strong>Include exectuion time</strong> box before running the query will also show the amount of time the query was executed in, allowing for more information that can be used for optimizing the indexes for your application or deployment.</p> 
   <p>The tool will also build a list of popular and slow queries that can be automatically loaded in the UI by clicking their name in the predefined list, as shown below.<br /> </p> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <img imageRotate="0" src="assets/chlimage_1-169.png" /> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <h4>The Oak Index Manager</h4> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <p>The Oak Index Manager is a simple WebUI created to facilitate index management such as maintaining indexes, viewing their status or triggering re-indexes.</p> 
   <p>It can be downloaded as a part of the <a href="https://adobe-consulting-services.github.io/acs-aem-commons/">ACS AEM Commons</a> package and installed via Package Manager in AEM.</p> 
   <p>Once installed, it can be accessed by going to <strong>Tools - ACS AEM Commons - Oak Index Manager</strong> from the welcome screen or by directly accesing the url at <span class="code">http://localhost:4502/etc/acs-commons/oak-index-manager.html</span></p> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <img imageRotate="0" src="assets/chlimage_1-170.png" /> 
  </draft-comment> 
  <draft-comment type="draft"> 
   <p>The UI can be used to filter indexes in the table by typing in the filter criteria in the search box in the upper left corner of the screen.</p> 
   <p>A single reindex can be triggered by clicking the icon in the <strong>Reindex</strong> column for the respective index. A bulk reindex can be triggered by selecting multiple indexes and clicking the <strong>Bulk Reindex</strong> button.</p> 
  </draft-comment> 
  <h4>Creating Property Indexes via OSGi</h4> 
  <p>The ACS Commons package also exposes OSGi configurations that can be used to create property indexes.</p> 
  <p>You can access it from the Web Console by searching for "<strong>Ensure Oak Property Index</strong>".</p> 
  <img imageRotate="0" src="assets/chlimage_1-171.png" /> 
  <h3>Troubleshooting indexing issues</h3> 
  <p>Situations may arise where queries take a long time to execute, and the general system response time is slow. </p> 
  <p>This section presents a set of recommendations on what needs to be done in order to track down the cause of such issues and advice on how to resolve them.<br /> </p> 
  <h4>Preparing Debugging Info for Analysis</h4> 
  <p>The easiest way to get required information for the query being executed is via the <a href="../../../sites/administering/using/operations-dashboard.md#main-pars-title-1097830066">Explain Query tool</a>. This will enable you to collect the precise information that is needed to debug a slow query without the need to consult the log level information. This is desirable if you know the query that is being debugged. </p> 
  <p>If this is not possible for any reason, you can gather the indexing logs in a single file and use it to troubleshoot your particular problem.</p> 
  <h4>Enable Logging</h4> 
  <p>To enable logging, you need to enable <strong>DEBUG</strong> level logs for the categories pertaining to Oak indexing and queries. These categories are:<br /> </p> 
  <ul> 
   <li>org.apache.jackrabbit.oak.plugins.index</li> 
   <li>org.apache.jackrabbit.oak.query</li> 
   <li>com.day.cq.search</li> 
  </ul> 
  <p>The <strong>com.day.cq.search</strong> category is only applicable if you are using the AEM provided QueryBuilder utility.</p> 
  <note> 
   <p>It is important that the logs are only set to DEBUG for the duration the query you want to troubleshoot is being executed, otherwise a large amount of events will be generated in the logs over time. Because of this, once the required logs are collected switch back to INFO level logging for the categories mentioned above.</p> 
  </note> 
  <p>You can enable logging by following this procedure:</p> 
  <ol> 
   <li><p>Point your browser to <span class="code">http://serveraddress:port/system/console/slinglog</span></p> </li> 
   <li><p>Click the <strong>Add new Logger</strong> button in the lower part of the console.<br /> </p> </li> 
   <li><p>In the newly created row, add the categories mentioned above. You can use the <strong>+</strong> sign to add more than one category to a single logger.<br /> </p> </li> 
   <li><p>Choose <strong>DEBUG</strong> from the <strong>Log level</strong> drop down list.<br /> </p> </li> 
   <li><p>Set the output file to <span class="code">logs/queryDebug.log</span>. This will correlate all the DEBUG events into a single log file.<br /> </p> </li> 
   <li><p>Run the query or render the page that is using the query you wish to debug.<br /> </p> </li> 
   <li><p>Once you have executed the query, go back to the logging console and change the log level of the newly created logger to <strong>INFO</strong>.<br /> </p> </li> 
  </ol> 
  <h4>Index Configuration</h4> 
  <p>The way the query gets evaluated is largely affected by the index configuration. It is important to get the index configuration in order to be analyzed or sent to support. You can either get the configuration as a content package or get a JSON rendition.</p> 
  <p>Since in most cases, the indexing configuration is stored under the <span class="code">/oak:index</span> node in CRXDE, you can get the JSON version at:</p> 
  <p><span class="code">http://serveraddress:port/oak:index.tidy.-1.json</span></p> 
  <p>If the index is configured at a different location, change the path accordingly.</p> 
  <h4>MBean output</h4> 
  <p>In some cases it is helpful to provide the output of index related MBeans for debugging. You can do this by:</p> 
  <ol> 
   <li><p>Going to the JMX console at: http://serveraddress:port/system/console/jmx<br /> </p> </li> 
   <li><p>Search for the following MBeans:</p> 
    <ul> 
     <li>Lucene Index statistics</li> 
     <li>CopyOnRead support statistics</li> 
     <li>Oak Query Statistics</li> 
     <li>IndexStats<br /> </li> 
    </ul> </li> 
   <li><p>Click each of the MBeans to get the performance statistics. Create a screenshot or note them down in case submission to support is required.<br /> </p> </li> 
  </ol> 
  <p>You can also get the JSON variant of these statistics at the following URLs:</p> 
  <ul> 
   <li><span class="code">http://serveraddress:port/system/sling/monitoring/mbeans/org/apache/jackrabbit/oak/%2522LuceneIndex%2522.tidy.-1.json</span></li> 
   <li><span class="code">http://serveraddress:port/system/sling/monitoring/mbeans/org/apache/jackrabbit/oak/%2522LuceneIndex%2522.tidy.-1.json</span></li> 
   <li><span class="code">http://serveraddress:port/system/sling/monitoring/mbeans/org/apache/jackrabbit/oak/%2522LuceneIndex%2522.tidy.-1.json</span></li> 
   <li><span class="code">http://serveraddress:port/system/sling/monitoring/mbeans/org/apache/jackrabbit/oak/%2522LuceneIndex%2522.tidy.-1.json</span></li> 
  </ul> 
  <p>You can also provide consolidated JMX output via <span class="code">http://serveraddress:port/system/sling/monitoring/mbeans/org/apache/jackrabbit/oak.tidy.3.json</span>. This would include all Oak related MBean details in JSON format.<br /> </p> 
  <h4>Other Details</h4> 
  <p>You can gather additional details in order to help troubleshoot the problem, such as:</p> 
  <ol> 
   <li>The Oak version your instance is running on. You can see this by opening CRXDE and looking at the version in the lower right corner of the welcome page, or by checking the version of the <span class="code">org.apache.jackrabbit.oak-core</span> bundle.</li> 
   <li>The QueryBuilder Debugger output of the troublesome query. The debugger can be accessed at: <span class="code">http://serveraddress:port/libs/cq/search/content/querydebug.html</span><br /> </li> 
  </ol> 
 </body> 
</html>