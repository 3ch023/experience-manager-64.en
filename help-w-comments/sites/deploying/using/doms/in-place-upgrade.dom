<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="Activate" name="cq:lastReplicationAction" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="locales:fr;locales:de;locales:ja" name="locLangTag" /> 
  <meta content="496348cb-9aeb-4376-86c1-d3631a9e4127" name="jcr:predecessors" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/deploying/morehelp/upgrading;/content/help/en/experience-manager/6-4/sites/deploying/morehelp/upgrading" name="moreHelpPaths" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="carlino" name="cq:lastModifiedBy" /> 
  <meta content="Performing an In-Place Upgrade" name="seoTitle" /> 
  <meta content="2018-05-03T10:53:36.176-0400" name="publishExternalDate" /> 
  <meta content="2017-11-29T07:08:47.203-0500" name="firstPublishExternalDate" /> 
  <meta content="2018-05-03T10:53:36.176-0400" name="lastPublishExternalDate" /> 
  <meta content="sarchiz" name="contentOwner" /> 
  <meta content="2018-05-03T10:53:36.176-0400" name="topicBrowsingSortDate" /> 
  <meta content="audience:deploying" name="primaryAudienceTag" /> 
  <meta content="en" name="pageCreatedAt" /> 
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/in-place-upgrade.html" name="publishExternalURL" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="2018-11-22T06:07:41.156-0500" name="cq:lastReplicated" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="sarchiz@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="2019-01-25T09:06:05.142-0500" name="cq:lastModified" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="2019-01-25T09:06:05.139-0500" name="locHandOffDate" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="Performing an In-Place Upgrade" name="jcr:title" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;content_type:reference;topic_tags:upgrading" name="cq:tags" /> 
  <meta content="false" name="isReadyForLocalization" /> 
  <meta content="sarchiz" name="cq:lastReplicatedBy" /> 
  <meta content="2018-02-10T08:01:13.002-0500" name="jcr:created" /> 
  <meta content="88b55b37-dff5-4fe1-94cb-8c7d62451b62" name="jcr:uuid" /> 
  <meta content="Learn how to perform an in-place upgrade." name="seoDescription" /> 
 </head> 
 <body> 
  <note> 
   <p>This page outlines the upgrade procedure for AEM 6.4. If you have an installation that is deployed to an application server, see <a href="../../../sites/deploying/using/app-server-upgrade.md">Upgrade Steps for Application Server Installations</a>.</p> 
  </note> 
  <h2 id="pre-upgrade-steps">Pre-Upgrade Steps</h2> 
  <p>Before executing your upgrade, there are several steps that must be completed. See <a href="../../../sites/deploying/using/upgrading-code-and-customizations.md">Upgrading Code and Customizations</a> and <a href="../../../sites/deploying/using/pre-upgrade-maintenance-tasks.md">Pre-Upgrade Maintenance Tasks</a> for more information. Additionally, make sure that your system meets the requirements for the new version of AEM. See how Pattern Detector can help you estimate the complexity of your upgarde and also see the Upgrade Scope and Requirements section of <a href="../../../sites/deploying/using/upgrade-planning.md">Planning Your Upgrade</a> for more information.</p> 
  <h2 id="migration-prerequisites">Migration Prerequisites</h2> 
  <ul> 
   <li><strong>Minimum Required Java version:</strong> The migration tool only works with Java versions 7 and up. Note that for AEM 6.3 and up, Oracle's JRE 8 and IBM's JRE 7 &amp; 8 are the only supported versions.<br /><br /> </li> 
   <li><strong>Upgraded Instance:</strong> If you are upgrading from a version <strong>older than 5.6</strong>, make sure that you have performed an in-place upgrade to AEM 6.0 by following the procedure described in the 6.0 version of the Upgrade documentation.</li> 
  </ul> 
  <h2 id="prep-quickstart-file">Preparation of the AEM Quickstart jar file</h2> 
  <ol> 
   <li><p>Stop the instance if it is running.<br /> </p> </li> 
   <li><p>Download the new AEM jar file and use it to replace the old one outside the <span class="code">crx-quickstart</span> folder.<br /> </p> </li> 
   <li><p>Unpack the new quickstart jar by running:<br /> </p> 
    <codeblock gutter="true" class="syntax shell">
      java&amp;nbsp;-Xmx4096m&amp;nbsp;-jar&amp;nbsp;aem-quickstart.jar&amp;nbsp;-unpack 
    </codeblock></li> 
  </ol> 
  <h2 id="content-repository-migration">Content Repository Migration</h2> 
  <p>This migration is not required if you are upgrading from AEM 6.3. For versions older than 6.3, Adobe provides a tool that can be used to migrate the repository to the new version of the Oak Segment Tar present in AEM 6.3. It is provided as part of the quickstart package and is mandatory for any upgrades that will be using TarMK. Upgrades for environments that are using MongoMK do not require repository migration. For more information on what the benefits of the new Segment Tar format are, see the <a href="../../../sites/deploying/using/revision-cleanup.md#onlinerevisioncleanupfrequentlyaskedquestions">Migrating to Oak Segment Tar FAQ</a>.</p> 
  <p>The actual migration is performed using the standard AEM quickstart jar file, executed with a new <span class="code">-x crx2oak</span> option which executes the crx2oak tool in order to simplify the upgrade and make it more robust.<br /> </p> 
  <note> 
   <p>If you are performing TarMK repository content migration using the CRX2Oak Quickstart extension, you might remove the <strong>samplecontent</strong> runmode by adding the following to the migration command line:</p> 
   <ul> 
    <li><span class="code">--promote-runmode nosamplecontent</span></li> 
   </ul> 
  </note> 
  <p>To determine the command that you should run, use the following command:</p> 
  <codeblock gutter="true" class="syntax shell">
    java&amp;nbsp;-Xmx4096m&amp;nbsp;-jar&amp;nbsp;aem-quickstart.jar&amp;nbsp;-v&amp;nbsp;-x&amp;nbsp;crx2oak&amp;nbsp;-xargs&amp;nbsp;--&amp;nbsp;--load-profile&amp;nbsp;&lt;&lt;YOUR_PROFILE&gt;&gt;&amp;nbsp;&lt;&lt;ADDITIONAL_FLAGS&gt;&gt; 
  </codeblock> 
  <p>Where <span class="code">&amp;lt;&amp;lt;YOUR_PROFILE&amp;gt;&amp;gt;</span> and <span class="code">&amp;lt;&amp;lt;ADDITIONAL_FLAGS&amp;gt;&amp;gt;</span> are replaced with the profile and flags listed in the following table:</p> 
  <table border="1" cellpadding="1" cellspacing="0" width="100%"> 
   <tbody> 
    <tr> 
     <td><strong>Source Repository</strong></td> 
     <td><strong>Target Repository</strong></td> 
     <td><strong>Profile</strong></td> 
     <td><strong>Additional Flags</strong><br /> </td> 
    </tr> 
    <tr> 
     <td>crx2 or TarMK with <span class="code">FileDataStore</span></td> 
     <td>TarMK</td> 
     <td>segment-fds</td> 
     <td>See Troubleshooting section below</td> 
    </tr> 
    <tr> 
     <td>crx2</td> 
     <td>MongoMK</td> 
     <td>mongo-from-crx2 </td> 
     <td><span class="code">-T mongo-uri=mongo://mongo-host:mongo-port -T mongo-db=mongo-database-name</span></td> 
    </tr> 
    <tr> 
     <td><span class="inline-comment-marker" data-ref="f44022c9-bcfa-4d04-86a1-7dffe87d094d">TarMK or crx2 with <span class="code">S3DataStore</span></span></td> 
     <td>TarMK</td> 
     <td>segment-custom-ds</td> 
     <td>See Troubleshooting section below</td> 
    </tr> 
    <tr> 
     <td>TarMK with no datastore</td> 
     <td>TarMK</td> 
     <td>segment-no-ds</td> 
     <td> </td> 
    </tr> 
    <tr> 
     <td>MongoMK</td> 
     <td>MongoMK</td> 
     <td>No migration is needed</td> 
     <td> </td> 
    </tr> 
   </tbody> 
  </table> 
  <p><strong>Where:</strong></p> 
  <ul> 
   <li><span class="code">mongo-host</span> is the MongoDB server IP (for example, 127.0.0.1)<br /> </li> 
   <li><span class="code">mongo-port</span> is the MongoDB server port (for example: 27017)<br /> </li> 
   <li><span class="code">mongo-database-name</span> represents the name of the database (for example: aem-author)</li> 
  </ul> 
  <p><strong>You may also require additional switches for the following scenarios:</strong></p> 
  <ul> 
   <li>If you are performing the upgrade on a Windows system where Java memory mapping is not handled correctly, please add the <span class="code">--disable-mmap</span> parameter to the command.<br /> </li> 
   <li>If you are using Java 7, add the <span class="code">-XX:MaxPermSize=2048m</span> parameter just after the <span class="code">-Xmx</span> parameter.</li> 
  </ul> 
  <p>For additional instructions on using the crx2oak tool, see Using the <a href="../../../sites/deploying/using/using-crx2oak.md">CRX2Oak Migration Tool</a>. The crx2oak helper JAR can be manually upgraded if needed, by manually replacing it with newer versions after unpacking the quickstart. Its location in the AEM installation folder is: <span class="code">&amp;lt;aem-install&amp;gt;/crx-quickstart/opt/extensions/crx2oak.jar</span>. The newest version of the CRX2Oak migration tool is available for download from the Adobe Repository at: <a href="https://repo.adobe.com/nexus/content/groups/public/com/adobe/granite/crx2oak/">https://repo.adobe.com/nexus/content/groups/public/com/adobe/granite/crx2oak/</a></p> 
  <p>If the migration has completed successfully, the tool will exit with an exit code of zero. Additionally, check for WARN and ERROR messages in the <span class="code">upgrade.log</span> file, located under <span class="code">crx-quickstart/logs</span> in the AEM installation directory, as these could indicate non-fatal errors that occurred during the migration.</p> 
  <p>Check the configuration files beneath <span class="code">crx-quickstart/install</span> folder. If a migration was necessary these will be updated to reflect the target repository.</p> 
  <p><strong>A note on datastores:</strong></p> 
  <p>While <span class="code">FileDataStore</span> is the new default for AEM 6.3 installations, using an external datastore is not required. While using an external datastore is recommended as a best practice for production deployments, it is not a prerequisite to upgrade. Due to the complexity already present in upgrading AEM, we recommend performing the upgrade without doing a datastore migration. If desired, a datastore migration can be executed afterwards as a separate effort.</p> 
  <h2 id="troubleshooting-migration-issues">Troubleshooting Migration Issues</h2> 
  <p>Please skip this section if you are upgrading from 6.3. While the provided crx2oak profiles should meet the needs of most customers, there are times when additional parameters will be necessary. If you run into an error during your migration, it is possible that there are aspects of your environment that require additional configuration options to be provided. If so, you will likely encounter the following error:</p> 
  <p><strong>Checkpoints won't be copied, because no external datastore has been specified. This will result in the full repository reindexing on the first start. Use --skip-checkpoints to force the migration or see https://jackrabbit.apache.org/oak/docs/migration.html#Checkpoints_migration for more info.</strong></p> 
  <p>For some reason, the migration process needs access to binaries in the datastore and is unable to find it. In order to specify your datastore configuration, include the following flags in the <span class="code">&amp;lt;&amp;lt;ADDITIONAL_FLAGS&amp;gt;&amp;gt;</span> portion of your migration command:</p> 
  <p><strong>For S3 datastores:</strong></p> 
  <codeblock gutter="true" class="syntax shell">
    --src-s3config=/path/to/SharedS3DataStore.config&amp;nbsp;--src-s3datastore=/path/to/datastore 
  </codeblock> 
  <p>Where <span class="code">/path/to/SharedS3DataStore.config</span> represents the path to your S3 datastore config file and <span class="code">/path/to/datastore</span> represents the path to your S3 datastore.</p> 
  <p><strong>For File datastores:</strong></p> 
  <codeblock gutter="true" class="syntax shell">
    --src-datastore=/path/to/datastore 
  </codeblock> 
  <p>Where <span class="code">/path/to/datastore</span> represents the path to your File Datastore.</p> 
  <h2 id="performing-the-upgrade">Performing The Upgrade</h2> 
  <p><strong>If using S3:</strong></p> 
  <ol> 
   <li><p>Remove any jars beneath <span class="code">crx-quickstart/install</span> associated with an earlier version of the S3 connector.<br /> </p> </li> 
   <li><p>Download the latest release of the 1.8.x S3 connector from <a href="https://repo.adobe.com/nexus/content/groups/public/com/adobe/granite/com.adobe.granite.oak.s3connector/">https://repo.adobe.com/nexus/content/groups/public/com/adobe/granite/com.adobe.granite.oak.s3connector/</a><br /> </p> </li> 
   <li><p>Extract the package to a temporary folder and copy the contents of <span class="code">jcr_root/libs/system/install</span> to the <span class="code">crx-quickstart/install</span> folder.<br /> </p> </li> 
  </ol> 
  <h3>Determining the correct upgrade start command</h3> 
  <p>To execute the upgrade, it is important to start AEM using the jar file to bring up the instance. For upgrading to 6.4, please also see other content restructuring and migration options in <a href="../../../sites/deploying/using/lazy-content-migration.md" style="font-size: 16px;">Lazy Content Migration</a> that you can choose with the upgrade command.</p> 
  <p>Note that starting AEM from the start script will not start the upgrade. Most customers start AEM using the start script and have customized this start script to include switches for environment configurations such as memory settings, security certificates, etc. For this reason, we recommend following this procedure to determine the proper upgrade command:</p> 
  <ol> 
   <li><p>On a running AEM instance, execute the following from the command line:<br /> </p> 
    <codeblock gutter="true" class="syntax shell">
      ps&amp;nbsp;-ef&amp;nbsp;|&amp;nbsp;grep&amp;nbsp;java 
    </codeblock></li> 
   <li><p>Look for the AEM process. It will look something like:<br /> </p> 
    <codeblock gutter="true" class="syntax shell">
      /usr/bin/java&amp;nbsp;-server&amp;nbsp;-Xmx1024m&amp;nbsp;-XX:MaxPermSize=256M&amp;nbsp;-Djava.awt.headless=true&amp;nbsp;-Dsling.run.modes=author,crx3,crx3tar&amp;nbsp;-jar&amp;nbsp;crx-quickstart/app/cq-quickstart-6.2.0-standalone-quickstart.jar&amp;nbsp;start&amp;nbsp;-c&amp;nbsp;crx-quickstart&amp;nbsp;-i&amp;nbsp;launchpad&amp;nbsp;-p&amp;nbsp;4502&amp;nbsp;-Dsling.properties=conf/sling.properties 
    </codeblock></li> 
   <li><p>Modify the command by replacing the path to the existing jar (<span class="code">crx-quickstart/app/aem-quickstart*.jar</span> in this case) with the new jar that is a sibling of the <span class="code">crx-quickstart</span> folder. Using our previous command as an example, our command would be:</p> 
    <codeblock gutter="true" class="syntax shell">
      /usr/bin/java&amp;nbsp;-server&amp;nbsp;-Xmx1024m&amp;nbsp;-XX:MaxPermSize=256M&amp;nbsp;-Djava.awt.headless=true&amp;nbsp;-Dsling.run.modes=author,crx3,crx3tar&amp;nbsp;-jar&amp;nbsp;cq-quickstart-6.4.0.jar&amp;nbsp;-c&amp;nbsp;crx-quickstart&amp;nbsp;-p&amp;nbsp;4502&amp;nbsp;-Dsling.properties=conf/sling.properties 
    </codeblock><p>This will ensure that all proper memory settings, custom runmodes, and other environmental parameters are applied for the upgrade. After the upgrade has completed, the instance may be started from the start script on future startups.</p> </li> 
  </ol> 
  <h2 id="deploy-upgraded-codebase">Deploy Upgraded Codebase</h2> 
  <p>Once the in-place upgrade process has been completed, the updated code base should be deployed. Steps for updating the code base to work in the target version of AEM can be found in <a href="../../../sites/deploying/using/upgrading-code-and-customizations.md">Upgrade Code and Customizations page</a>. </p> 
  <h2 id="perform-post-upgrade-check-troubleshooting">Perform Post-Upgrade Checks and Troubleshooting</h2> 
  <p>See <a href="../../../sites/deploying/using/post-upgrade-checks-and-troubleshooting.md">Post Upgrade Checks and Troubleshooting</a>.</p> 
 </body> 
</html>