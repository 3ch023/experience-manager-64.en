<?xml version="1.1" encoding="UTF-8" standalone="yes"?> 
<html> 
 <head> 
  <meta content="2018-05-24T06:29:44.101-0400" name="topicBrowsingSortDate" /> 
  <meta content="" name="jcr:baseVersion" /> 
  <meta content="raiman" name="cq:lastReplicatedBy" /> 
  <meta content="https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/troubleshoot-rep.html" name="publishExternalURL" /> 
  <meta content="9cd48fba-6d9e-4c82-a649-4331c4bb8560" name="jcr:uuid" /> 
  <meta content="/apps/help/templates/article-3" name="cq:template" /> 
  <meta content="2017-10-12T21:46:00.000-0400" name="qaDate" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES" name="primaryProductTag" /> 
  <meta content="products:SG_EXPERIENCEMANAGER/6.4/SITES;content_type:reference;topic_tags:configuring" name="cq:tags" /> 
  <meta content="Guillaume Carlino" name="contentOwner" /> 
  <meta content="admin" name="jcr:createdBy" /> 
  <meta content="Troubleshooting Replication" name="navTitle" /> 
  <meta content="Troubleshooting Replication" name="seoTitle" /> 
  <meta content="2017-10-12T21:46:58.665-0400" name="mwpw_migration_script_version" /> 
  <meta content="9d5a2f90-5c65-4aa3-9778-61d5f1684eb8" name="jcr:predecessors" /> 
  <meta content="Troubleshooting Replication" name="jcr:title" /> 
  <meta content="en_us" name="jcr:language" /> 
  <meta content="2017-10-31T16:17:33.663-0400" name="firstPublishExternalDate" /> 
  <meta content="/content/docs/en/aem/6-3/deploy/troubleshoot-rep" name="qaNotes" /> 
  <meta content="mix:versionable" name="jcr:mixinTypes" /> 
  <meta content="2018-04-30T03:29:18.626-0400" name="locHandOffDate" /> 
  <meta content="/content/help/en/experience-manager/6-4/sites/deploying/morehelp/configuring;/content/help/en/experience-manager/6-4/sites/deploying/morehelp/configuring" name="moreHelpPaths" /> 
  <meta content="2017-12-01T19:07:06.169-0500" name="jcr:created" /> 
  <meta content="true" name="jcr:isCheckedOut" /> 
  <meta content="" name="jcr:versionHistory" /> 
  <meta content="2018-05-24T06:29:44.117-0400" name="cq:lastReplicated" /> 
  <meta content="raiman@adobe.com" name="lr_lastReplicatedBy" /> 
  <meta content="" name="jcr:primaryType" /> 
  <meta content="Activate" name="cq:lastReplicationAction" /> 
  <meta content="help/components/pages/article-3" name="sling:resourceType" /> 
  <meta content="2018-05-24T06:29:44.104-0400" name="cq:lastModified" /> 
  <meta content="/etc/designs/help" name="cq:designPath" /> 
  <meta content="audience:deploying" name="primaryAudienceTag" /> 
  <meta content="2018-05-24T06:29:44.101-0400" name="lastPublishExternalDate" /> 
  <meta content="false" name="isReadyForLocalization" /> 
  <meta content="This article provides information on how to troubleshoot replication issues." name="seoDescription" /> 
  <meta content="raiman" name="cq:lastModifiedBy" /> 
  <meta content="2018-05-24T06:29:44.101-0400" name="publishExternalDate" /> 
 </head> 
 <body> 
  <p>This page provides information on how to troubleshoot replication issues.</p> 
  <h4>Problem</h4> 
  <p>Replication (non-reverse replication) is failing for some reason.</p> 
  <h4>Resolution</h4> 
  <p>There are various reasons for replication to fail. This article explains the approach one might take when analyzing these issues.</p> 
  <p><strong>Are replications getting triggered at all when clicking the Activate button? If NOT then do the following:</strong></p> 
  <ol> 
   <li>Go to /crx/explorer (CQ5.5) and login as admin.</li> 
   <li>Open "Content Explorer"</li> 
   <li>See if a node /bin/replicate or /bin/replicate.json exists. If the node exists then delete it and save.</li> 
  </ol> 
  <p><strong>Are the replications getting queued up in the replication agent queues?</strong></p> 
  <p>Check this by going to /etc/replication/agents.author.html then click on the replication agents to check.</p> 
  <p><strong>If one agent queue or a few agent queues are stuck:</strong></p> 
  <ol> 
   <li>Does the queue show <strong>blocked</strong> status? If so then is the publish instance not running or totally unresponsive? Check the publish instance to see what is wrong with it (i.e. check the logs, and see if there is an OutOfMemory error or some other issue. Then if it is just generally slow then take thread dumps and analyze them.</li> 
   <li>Does the queue status show <strong>Queue is active - # pending</strong>? Basically the replication job could be stuck in a socket read waiting for the pubilsh instance or dispatcher to respond. This could mean that the publish instance or dispatcher is under high load or stuck in a lock. Take thread dumps from author and publish in this case. 
    <ul> 
     <li>Open the thread dumps from author in a thread dump analyzer, check if it shows that the replication agent's sling eventing job is stuck in a socketRead.</li> 
     <li>Open the thread dumps from publish in a thread dump analyzer, analyze what might be causing the publish instance not to respond. You should see a thread with POST /bin/receive in its name, that is the thread receiving the replication from author.</li> 
    </ul> </li> 
  </ol> 
  <p><strong>If all agent queues are stuck</strong></p> 
  <ol> 
   <li>It is possible that a certain piece of content cannot be serialized under /var/replication/data due to repository corruption or some other issue. Check the logs/error.log for a related error. To clear out the bad replication item, do the following: 
    <ol> 
     <li>Go to http://&amp;lt;host&amp;gt;:&amp;lt;port&amp;gt;/crx and login as admin user. In CQ5.5 go to http://&amp;lt;host&amp;gt;:&amp;lt;port&amp;gt;/crx/explorer instead.</li> 
     <li>Click on "Content Explorer".</li> 
     <li>In the "Content Explorer" window click on the magnifying glass button on the top right of the window and a search dialog will pop up.</li> 
     <li>Select the "XPath" radio button.</li> 
     <li>In the "Query" box enter this query /jcr:root/var/eventing/jobs//element(*,slingevent:Job) order by @slingevent:created</li> 
     <li>Click "Search"</li> 
     <li>In the results the top items are the latest sling eventing jobs. Click on each one and find the stuck replications that match what shows up in the top of the queue.</li> 
    </ol> </li> 
   <li>There might be something wrong with sling eventing framework job queues. Try restarting the org.apache.sling.event bundle in the/system/console.</li> 
   <li>It might be that job processing is completely turned off. You can check that under Felix Console in the Sling Eventing Tab. Check if it displays - Apache Sling Eventing (JOB PROCESSING IS DISABLED!) 
    <ul> 
     <li>If yes, then check Apache Sling Job Event Handler under Configuration tab in Felix Console. Might be that 'Job processing Enabled' checkbox is unchecked. If that is checked and still it displays that 'job processing is disabled', then check if there is any overlay under /apps/system/config that is disabling the job processing. Try creating an osgi:config node for jobmanager.enabled with a boolean value to true and re-check if the activation started and there are no more jobs in queue.</li> 
    </ul> </li> 
   <li>It might also be the case that DefaultJobManager configuration gets into an inconsistent state. This can happen when someone manually modifies the 'Apache Sling Job Event Handler' configuration via the OSGiconsole (For example disable and re-enable the 'Job Processing Enabled' property and Save the configuration). 
    <ul> 
     <li>At this point the DefaultJobManager configuration which is stored at crx-quickstart/launchpad/config/org/apache/sling/event/impl/jobs/DefaultJobManager.config gets into an inconsistent state. And even though the 'Apache Sling Job Event Handler' property shows 'Job Processing Enabled' to be in checked state, when one navigates to the Sling Eventing tab, it shows the message - JOB PROCESSING IS DISABLED and the replication does not work.</li> 
     <li>To resolve this issue, one would need to navigate to the Configuration page of the OSGi console and delete the 'Apache Sling Job Event Handler' configuration. Then restart the Master node of the cluster to get the configuration back into a consistent state. This should fix the issue and replication will start working again.</li> 
    </ul> </li> 
  </ol> 
  <p><strong>Create a replication.log</strong></p> 
  <p>Sometimes it can be very helpful to set all replication logging to be added in a separate log file at DEBUG level. To do this:</p> 
  <ol> 
   <li>Go to http://host:port/system/console/configMgr and login as admin.</li> 
   <li>Find the Apache Sling Logging Logger factory and create an instance by clicking the <strong>+</strong> button on the right of the factory configuration. This will create a new logging logger.</li> 
   <li>Set the configuration like this: 
    <ul> 
     <li>Log Level: DEBUG</li> 
     <li>Log File Path: <i>(CQ5.4 and 5.3)</i> ../logs/replication.log <i>(CQ5.5)</i> logs/replication.log</li> 
     <li>Categories: com.day.cq.replication</li> 
    </ul> </li> 
   <li>If you suspect the problem to be related to sling eventing/jobs in any way then you can also add this java package under categories:org.apache.sling.event</li> 
  </ol> 
  <h4>Pausing Replication Agent Queue </h4> 
  <p>Sometime it might be suitable to pause the replication queue to reduce load on the author system, without disabling it. Currently this is only possible by a hack of temporarily configuring an invalid port. From 5.4 onwards you could see pause button in replication agent queue it has some limitation</p> 
  <ol> 
   <li>The state is not persisted that means if you restart a server or replication bundle is recycled it gets back to running state.</li> 
   <li>The pause is idle for a shorter period (OOB 1 hour after no activities with replication by other threads) and not for a longer time. Because There is feature in sling which avoid idle threads. Basically check if a job queue thread has been unused for a longer time, if so it kicks up clean up cycles. Due to cleanup cycle it stops the thread and hence the paused setting is lost. Since jobs are persisted it initiates a new thread to process the queue which does not have details of the paused configuration. Due to this queue turns into running state.</li> 
  </ol> 
  <h4>Page Permissions are not Replicated on User Activation</h4> 
  <p>Page permissions are not replicated because they are stored under the nodes to which access is granted, not with the user.<br /> </p> 
  <p>In general page permissions should not be replicated from the author to publish and are not by default. This is because access rights should be different in those two environments. Therefore it is recommended to configure ACLs on publish separately from author.</p> 
  <h4>Replication queue blocked when replicating namespace information from Author to Publish</h4> 
  <p>In some cases the replication queue is blocked when trying to replicate namespace information from the author instance to the publish instance. This happens because the replication user does not have <span class="code">jcr:namespaceManagement</span> privilege. To avoid this issue, make sure that:</p> 
  <ul> 
   <li>The replication user (as configured under the <a href="../../../sites/deploying/using/replication.md#replicationagentsconfigurationparameters">Transport</a> tab&amp;gt;User) also exists on the Publish instance.</li> 
   <li>The user has read and write privileges at the path where the content is installed.</li> 
   <li>The user has <span class="code">jcr:namespaceManagement</span> privilege at the repository level. You can grant the privilege as follows:</li> 
  </ul> 
  <ol> 
   <li><p>Login to CRX/DE (<span class="code">http://localhost:4502/crx/de/index.jsp</span>) as administrator.</p> </li> 
   <li><p>Click on the <strong>Access Control</strong> tab.</p> </li> 
   <li><p>Select <strong>Repository</strong>.</p> </li> 
   <li><p>Click <strong>Add Entry</strong> (the plus icon).</p> </li> 
   <li><p>Enter the name of the user.</p> </li> 
   <li><p>Select <span class="code">jcr:namespaceManagement</span> from the privileges list.</p> </li> 
   <li><p>Click OK.</p> </li> 
  </ol> 
 </body> 
</html>